<!doctype html>
<html lang="es">
    <head>
        <title>Trabajo Final - Pruebas unitarias en Python</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0;" />
        <link href="https://fonts.googleapis.com/css?family=Comfortaa&display=swap" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono&display=swap" rel="stylesheet"> 
        <style>
            body {
                font-family: 'Comfortaa';
                text-align: justify;
                margin-left: auto;
                margin-right: auto;
                background-color: #559955;
            }

            .breakable-word {
                word-break: normal;
                overflow-wrap: anywhere;
            }

            pre.source-code {
                word-break: normal;
                overflow-wrap: anywhere;
                margin-top: 0;
                white-space: pre-wrap;
                color: white;
                font-family: 'Ubuntu Mono', monospace;
                background-color: black;
                border-radius: 10px;
                border: 2px solid white;
                text-align: left;
                padding: 1em 0em 1em 4em;
            }

            figure {
                margin-left: auto;
                margin-right: auto;
                text-align: center;
            }

            figcaption {
                text-align: center;
                font-size: x-small;
            }

            div.source-code-header {
                font-family: 'Ubuntu Mono', monospace;
                margin-bottom: -2px;
                padding: 4px 0px 4px 0px;
                text-align: center;
                color: white;
                background-color: black;
                border-radius: 10px;
                border: 2px solid white;
            }
 
            pre.json {
                display: block;
                font-family: 'Ubuntu Mono', monospace;
                background-color: #c4a178;
                white-space: pre-wrap;
                word-break: normal;
                overflow-wrap: anywhere;
                border-radius: 10px;
            }

            .partial-listing {
                position: relative;
                padding: 1em 4em 3em 4em;
            }

            .partial-listing:after {
                background-repeat: repeat-x;
                content: " ";
                position: absolute;
                height: 32px;
                left: 0px;

            }

            span.url-api, span.command-line {
                font-family: 'Ubuntu Mono', monospace;
                background-color: #ffac4d;
                padding: 1px;
                border: 1px solid black;
                font-size: small;
            }

            @media all and (max-width: 599px) {
                body {
                    width: 95%;
                }

                figure img {
                    width: 95%;
                }

                pre.source-code {
                    border: 1px solid white;
                    font-size: x-small;
                    padding: 1em 0em 1em 1em;
                }

                div.source-code-header {
                    border: 1px solid white;
                    margin-bottom: -1px;
                    font-size: small;
                }

                .partial-listing:after {
                    background: linear-gradient(-20deg, #ffffff 4px, transparent 0), linear-gradient(20deg, #ffffff 4px, transparent 0);
                    background-size: 16px;
                    width: 99%;
                    bottom: -1px;
                }

                pre.json {
                    padding: 1em;
                    font-size: small;
                }

                span.url-api, span.command-line {
                    padding: 3px;
                    font-size: x-small;
                }

                h2 {
                    text-align: left;
                    padding: 1em 0em 1em 0em;
                    font-size: large;
                }
            }
 
            @media all and (min-width: 600px) and (max-width: 1023px) {
                body {
                    width: 85%;
                }

                pre.source-code {
                    font-size: small;
                    padding: 1em 0em 1em 2em;
                }

                figure img {
                    width: 85%;
                }

                .partial-listing:after {
                    background: linear-gradient(-30deg, #ffffff 6px, transparent 0), linear-gradient(30deg, #ffffff 6px, transparent 0);
                    background-size: 16px;
                    width: 100%;
                    bottom: -1px;
                }

                pre.json {
                    padding: 1em 2em 1em 2em;
                }

                h2 {
                    padding: 1em 0em 1em 0em;
                }
            }

            @media all and (min-width: 1024px) {
                body {
                    width: 75%;
                }

                pre.source-code {
                    padding: 1em 4em 2em 1em;
                }

                .partial-listing:after {
                    background: linear-gradient(-45deg, #ffffff 8px, transparent 0), linear-gradient(45deg, #ffffff 8px, transparent 0);
                    background-size: 16px;
                    width: 100%;
                    bottom: 0px;
                }

                pre.json {
                    padding: 2em 4em 2em 4em;
                }

                h2 {
                    padding: 1em 0em 1em 0em;
                }
            }

            @media all and (min-width: 840px) {
                figure img {
                    width: 700px;
                }
            }
           
            .green {
                color: #459607;
            }
            
            .blue {
                color: #569cd6;
            }
            
            .magenta {
                color: #c586c0;
            }
            
            .emerald {
                color: #49c994;
            }
            
            .yellow {
                color: #dcdcaa;
            }
            
            .gold {
                color: #b5b86b;
            }
            
            .cyan {
                color: #9cdcfe;
            }
            
            .orange {
                color: #ce9178;
            }

            h1 {
                text-align: center;
            }
        </style>
    </head>
    <body>
        <h1>Pruebas unitarias en Python</h1>

        <h2 id="introduccion">Introducción</h2>
        <p>Las <a href="https://es.wikipedia.org/wiki/Desarrollo_%C3%A1gil_de_software">metodologías ágiles</a> son consideradas como una evolución de la metodología clásica <a href="https://es.wikipedia.org/wiki/Desarrollo_en_cascada">o de cascada</a>. Una de las diferencias principales es la forma en la que plantean la fase de testing o prueba: para el desarrollo en cascada el testing es una fase que viene una vez terminada la fase de desarrollo, mientras que para el desarrollo ágil las pruebas son tan importantes o inclusive más que el código fuente.</p>
        <p>Por definición cuando un programador se equivoca al codificar está introduciendo un error o <em>bug</em> al software (por ejemplo, utilizar <em>=</em> en lugar de <em>==</em>, equivocarse en el orden de los paréntesis o usar la variable equivocada). Dicho error provoca un defecto o <em>fault</em> en una sentencia que, al ser ejecutada, provoca una falla o <em>failure</em>. Esta falla, sin embargo, puede ser evidente o no. Si es evidente se vuelve un <em>incidente</em> que será reportado al observarse (por ejemplo, por el usuario final) pero puede ser que sea tan sutil que no sea notado en mucho tiempo.</p>
        <p>Por consiguiente no cabe la menor duda de la conveniencia de encontrar errores tan pronto como sea posible, y las pruebas unitarias son la forma aceptada de hacerlo. Sin embargo, muchas veces se corre el peligro de no crearlos por problemas en el código, no ejecutarlos por ser lentos (ya sea por no estar optimizados y probar combinaciones innecesarias o por estar mal planteados), o no actualizarlos por ser débiles (dejan de compilar tan pronto como modificaciones son insertadas en el software por tener un <a href="https://es.wikipedia.org/wiki/Acoplamiento_(inform%C3%A1tica)">alto acoplamiento</a>, porque cuesta crear nuevas pruebas por tener <a href="https://es.wikipedia.org/wiki/Cohesi%C3%B3n_(inform%C3%A1tica)">baja cohesión</a>, etc).</p>
        <p>Una de las metodologías ágiles que intenta evitar dichos problemas es <em>TDD</em> o <em>Test-driven Development</em> (<a href="https://es.wikipedia.org/wiki/Desarrollo_guiado_por_pruebas">desarrollo guiado por pruebas</a>) la cual enfatiza mantener el código en sincronía con las pruebas. Para ello se enfoca en hacer que el equipo de desarrollo interprete correctamente las especificaciones y las transforme en pruebas unitarias antes de iniciar la codificación. Ésta es la metodología que se usará en los ejemplos de este trabajo, intentando demostrar la importancia y conveniencia de las pruebas unitarias.</p>

        <h2 id="ambientesdesarrollo">Ambiente de desarrollo</h2>
        <p>Para empezar con un ambiente limpio de desarrollo se pueden seguir las instrucciones de <a href="https://docs.python.org/3/tutorial/venv.html">la documentación oficial</a>, ejecutando <span class="command-line">python3 -m venv unit-testing</span> para luego seleccionarla con <span class="command-line">source unit-testing/bin/activate</span> en Linux (o <span class="command-line">unit-testing\scripts\activate</span> en Windows). Este paso es opcional, ya que es totalmente posible utilizar un ambiente ya creado o la instalación original.</p>
        <p>En cuanto a entorno de desarrollo, es posible ejecutar los ejemplos utilizando tanto línea de comando o interface gráfica (por ejemplo, <a href="https://code.visualstudio.com/">Visual Studio Code</a>). Los ejemplos aquí dados serán ejecutados por línea de comando por conveniencia, para poder mostrar el resultado de los comandos sin necesidad de incorporar imágenes.</p>

        <h2 id="registracion">Registración de cuenta en OpenWeather</h2>
        <p>Para tener una idea de los datos que se pueden recibir del servidor es necesario verificar la API pública de <em>OpenWeather</em>, para lo cual hay que registrarse desde <a href="https://openweathermap.org/api">la sección de Weather API</a> en el sitio.</p>
        <figure class="center">
            <img src="001openweather.png" alt="Página principal de OpenWeather API" />
            <figcaption>Página con las instrucciones sobre como usar la API de clima.</figcaption>
        </figure>
        <p>Una vez accedido a la cuenta es posible crear una nueva <a href="https://home.openweathermap.org/api_keys">API key</a> (por ejemplo, <em>Python Unit Testing</em>). Esta <em>key</em> es necesaria para que puedan limitar la cantidad de veces que una aplicación accede a los datos.</p>
        <figure>
            <img src="002new-api-key.png" alt="Registración de API key" />
            <figcaption>Creación de una API key para poder acceder a los datos a través de la API.</figcaption>
        </figure>

        <p>En el plan gratuito tanto el <a href="https://openweathermap.org/current">clima actual</a> como el <a href="https://openweathermap.org/forecast5">pronóstico del tiempo para los próximos 5 días</a> (en secciones de 3 horas, o sea 40 datos en total) pueden usarse con un máximo de 60 llamadas por minuto. Por ser una prueba de concepto se utilizará únicamente la <em>API</em> del clima actual.</p>

        <h2 id="ejemplojson">Ejemplo de datos del clima actual</h2>
        <p>Los datos del clima actual se piden a través de la dirección: <span class="url-api">https://api.openweathermap.org/data/2.5/weather?q={city name},{country code}&amp;appid={apikey}</span>. El ejemplo que tiene el sitio se puede acceder <a href="https://samples.openweathermap.org/data/2.5/weather?q=London,uk&appid=b6907d289e10d714a6e88b30761fae2">desde aquí</a>, y genera la siguiente respuesta:</p>
        <pre class="json">
{
    &quot;coord&quot;: {
        &quot;lon&quot;: -0.13,
        &quot;lat&quot;: 51.51
    },
    &quot;weather&quot;: [
        {
            &quot;id&quot;: 300,
            &quot;main&quot;: &quot;Drizzle&quot;,
            &quot;description&quot;: &quot;light intensity drizzle&quot;,
            &quot;icon&quot;: &quot;09d&quot;
        }
    ],
    &quot;base&quot;: &quot;stations&quot;,
    &quot;main&quot;: {
        &quot;temp&quot;: 280.32,
        &quot;pressure&quot;: 1012,
        &quot;humidity&quot;: 81,
        &quot;temp_min&quot;: 279.15,
        &quot;temp_max&quot;: 281.15
    },
    &quot;visibility&quot;: 10000,
    &quot;wind&quot;: {
        &quot;speed&quot;: 4.1,
        &quot;deg&quot;: 80
    },
    &quot;clouds&quot;: {
        &quot;all&quot;: 90
    },
    &quot;dt&quot;: 1485789600,
    &quot;sys&quot;: {
        &quot;type&quot;: 1,
        &quot;id&quot;: 5091,
        &quot;message&quot;: 0.0103,
        &quot;country&quot;: &quot;GB&quot;,
        &quot;sunrise&quot;: 1485762037,
        &quot;sunset&quot;: 1485794875
    },
    &quot;id&quot;: 2643743,
    &quot;name&quot;: &quot;London&quot;,
    &quot;cod&quot;: 200
}
</pre>
        <p>Conociendo los datos disponibles se pueden seleccionar los que se van a mostrar durante la ejecución de la aplicación: el título del clima y su descripción (localizado en <em>weather)</em>, las temperaturas (dentro de <em>main)</em>, el nombre de la ciudad (en <em>name)</em>, las coordenadas (en <em>coord)</em> y el nombre del país (en la raíz).</p>

        <h2 id="implementacion">Lineamientos principales de una prueba</h2>
        <p>De acuerdo a la metodología de <a href="https://es.wikipedia.org/wiki/Desarrollo_guiado_por_pruebas">desarrollo guiado por pruebas</a> o <em>TDD</em> se empieza planeando la prueba unitaria antes de empezar a programar el software en sí. Para realizar pruebas unitarias utilizaremos la librería <a href="https://docs.python.org/3/library/unittest.html">unittest</a>.</p>
        <p>Se crea un directorio llamado <em>clima</em> y dentro de ése un archivo llamado <em>clima_test.py</em> dentro del cual se escribirá la primera prueba unitaria:</p>

      <div class="source-code-header">clima_test.py</div>
      <pre class="source-code full-listing">
<span class="magenta">import</span> unittest
<span class="magenta">import</span> clima

<span class="blue">class</span> <span class="emerald">ClimaUnitTests</span>(<span class="emerald">unittest.TestCase</span>):
    <span class="blue">def</span> <span class="yellow">test_constructor_con_una_apikey_valida_deberia_incorporarla</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        apikey = <span class="orange">&quot;abcdefg&quot;</span>

        <span class="green"># Act</span>
        sut = clima.Clima(apikey)

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(apikey, sut.apikey)

<span class="magenta">if</span> <span class="cyan">__name__</span> == <span class="orange">&quot;__main__&quot;</span>:
          unittest.main()
</pre>

        <p>Como puede apreciarse se importa tanto el módulo <em>unittest</em> (que permitirá ejecutar las pruebas unitarias) y un módulo llamado <em>clima</em> (que <strong>aún no existe</strong>). Luego se define una clase llamada <em>ClimaUnitTests</em> que hereda de <em>unittest.TestCase</em>. Las pruebas unitarias se agrupan en casos de prueba o <em>test cases</em>, cada método dentro de la clase se volverá una prueba a ejecutar.</p>
        <p>La clase <em>ClimaUnitTests</em> tiene un método llamado <em class="breakable-word">test_constructor_con_una_apikey_valida_deberia_incorporarla</em>. Los nombres deben ser descriptivos, en este caso se utiliza primero <em>test</em> (el cual es obligatorio para que sea detectado como una prueba), luego el nombre del método a probar, luego una frase que utiliza &quot;con&quot; y la conjugación en potencial del verbo &quot;deber&quot;. En otras palabras, <em>metodo_con_xxx_deberia_yyy</em>. En el ejemplo se quiere probar que al construir un objeto de la clase <em>Clima</em> y pasarle una <em>API key</em>, dicha <em>API key</em> se incorpora dentro del estado del objeto y por consiguiente se puede acceder a través de la propiedad <em>apikey</em>.</p>
        <p>Aquí además se puede apreciar una característica de las pruebas unitarias: Se dividen en tres secciones: <strong>Arrange</strong> (arreglo, preparación o inicialización), <strong>Act</strong> (acto o ejecución) y <strong>Assert</strong> (aseveración, validación o comprobación). Aunque dependiendo del desarrollador se puede agregar un comentario al inicio de cada sección o dejar una línea en blanco entre ellas, lo importante es que se puedan distinguir perfectamente (especialmente la sección donde se realiza la ejecución de la línea a probar, que debería ser única. La sección de preparación usualmente tiene como máximo unas 10 líneas, si fuese más largo podría ser conveniente dividir la funcionalidad en secciones más cortas. Y aunque normalmente se menciona que también debería existir una única aseveración, en realidad es más correcto pensar en &quot;tantas aseveraciones como sean necesarias para probar que la prueba en sí no haya fallado&quot;. Por ejemplo, si se quiere probar que es posible crear una instancia de un objeto con verificar que la hipotética función <em>crear</em> devuelve algo que no sea nulo. Sin embargo, si la prueba consiste en verificar que la instancia creada por dicha hipotética función está inicializada correctamente, podrían ser necesarias una comprobación por cada atributo.</p>
        <p>Finalmente se llama al método <em>unittest.main</em> para ejecutar las pruebas.</p>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py
Traceback (most recent call last):
  File &quot;clima_test.py&quot;, line 2, in &lt;module&gt;
    import clima
ModuleNotFoundError: No module named 'clima'
</pre>

        <p>Obviamente al intentar ejecutar el programa (ya sea desde línea de comando o con una interface gráfica) ocurrirá un error indicando que no existe el módulo &quot;clima&quot;. Esto forma parte del planteo <em>TDD</em>: primero se debe provocar el error para partir sabiendo que el caso de prueba falla. El siguiente paso es escribir el mínimo código necesario para que la prueba sea exitosa, y por último <a href="https://es.wikipedia.org/wiki/Refactorizaci%C3%B3n">refactorear</a> el código para eliminar código duplicado. Esto normalmente se conoce como <em>red</em>, <em>green</em> y <em>yellow/blue/refactor</em> en la jerga: primero se provoca el error (estado &quot;rojo&quot;), luego se implementa la solución más simple (estado &quot;verde&quot;), y finalmente se procede a limpiar el código, a refactorearlo para mejorar u optimizar su funcionamiento (etapa &quot;amarilla&quot;). Ya que en la segunda etapa se está seguro que se ha implementado correctamente la solución es posible pasar a la tercer etapa; cualquier modificación que haga fallar a la/s prueba/s indicará que se debe volver al código anterior de la modificación o buscar la forma de repararlo. En otras palabras, no tiene sentido refactorear código que no funciona.</p>
        <p>Aunque la prueba falló viendo el código de la misma se puede notar que ya está decidido el nombre de la clase (<em>Clima</em>), que debe tener un constructor que reciba al menos la <em>API key</em>, y que debe tener una propiedad que retorne dicho valor. En base a esas premisas es posible escribir el siguiente código en un archivo llamado <em>clima.py</em>:</p>

        <div class="source-code-header">clima.py</div>
        <pre class="source-code full-listing">
<span class="blue">class</span> <span class="emerald">Clima</span>:
    <span class="blue">def</span> <span class="yellow">__init__</span>(<span class="cyan">self</span>, <span class="cyan">apikey</span>: <span class="emerald">str</span>):
        <span class="blue">self</span>.apikey = apikey
</pre>

        <p>Esta es la implementación mínima elegida: Una clase que tiene un constructor que recibe la <em>API key</em> y la guarda en un miembro que puede ser accedido desde afuera. Otra implementación mínima válida para <em>TDD</em> es crear una propiedad que retorne exactamente el mismo valor &quot;abcdefg&quot;, ya que permitiría pasar la prueba (de hecho, esa sería la implementación en la mayoría de los tutoriales o charlas dirigidas a novatos, por razones de brevedad es omitida).</p>
        <p>Esta vez al ejecutar la prueba validará:</p>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>: <span class="blue">~/src/python/clima</span>$ python3 clima_test.py
.
----------------------------------------------------------------------
Ran 1 test in 0.000s

OK
</pre>

<p>El punto que aparece en la segunda línea es la representación de la ejecución de la prueba. Un <strong>.</strong> o punto indica que se ejecutó con éxito, una <strong>E</strong> indicaría un error inesperado en tiempo de ejecución, y una <strong>F</strong> indicaría que alguna de las comprobaciones hechas resultó falsa. Como por el momento no hay nada que refactorear se puede agregar una nueva funcionalidad a la clase: si se le intenta pasar una <em>API key</em> vacía debería lanzar una excepción. Para ello primero se implementa una nueva prueba:</p>

        <div class="source-code-header">clima_test.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">test_constructor_con_una_apikey_vacia_deberia_lanzar_valueerror</span>(<span class="cyan">self</span>):
        <span class="magenta">with</span> <span class="blue">self</span>.assertRaises(<span class="emerald">ValueError</span>) <span class="magenta">as</span> ve:
            sut = clima.Clima(<span class="orange">&quot;&quot;</span>)
</pre>

        <p>El borde en zigzag indica que no se está mostrando el código completo del archivo sino que se está mostrando solo una porción de código por lo que se deberá prestar atención al copiarlo.</p>

        <p>Lo que se quiere es que al intentar crear una clase sin una <em>API key</em> no debería permitirlo y debería lanzar una excepción, así que se utiliza <em>with</em> para crear un contexto en el cual se atrapará únicamente la excepción <em>ValueError</em> y se intenta crear la clase. Si dicha excepción es lanzada la prueba continuará (ya que es lo esperado), si una excepción distinta es lanzada, o si no se lanza ninguna excepción, la prueba fallará. Al ejecutar la prueba:</p>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py 
F.
======================================================================
FAIL: test_constructor_con_una_apikey_vacia_deberia_lanzar_valueerror (__main__.ClimaUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;clima_test.py&quot;, line 13, in test_constructor_con_una_apikey_vacia_deberia_lanzar_valueerror
    sut = clima.Clima(&quot;&quot;)
AssertionError: ValueError not raised

----------------------------------------------------------------------
Ran 2 tests in 0.000s

FAILED (failures=1)
</pre>

        <p>La prueba falla porque la comprobación esperaba que haya una excepción y no hubo ninguna al no haber sido codificada aún. Como siguiente paso es necesario agregar el mínimo código posible para que la prueba pase. En este caso se agrega una validación, si la <em>API key</em> está vacía se lanza la excepción <em>ValueError</em>. Luego se confirma que la prueba ahora pasa:</p>

        <div class="source-code-header">clima.py</div>
        <pre class="source-code full-listing">
<span class="blue">class</span> <span class="emerald">Clima</span>:
    <span class="blue">def</span> <span class="yellow">__init__</span>(<span class="cyan">self</span>, <span class="cyan">apikey</span>: <span class="emerald">str</span>):
        <span class="magenta">if</span> apikey == <span class="orange">&quot;&quot;</span>:
            <span class="magenta">raise</span> <span class="emerald">ValueError</span>()

        <span class="blue">self</span>.apikey = apikey
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py 
..
----------------------------------------------------------------------
Ran 2 tests in 0.000s

OK
</pre>

        <p>Existen dos problemas extras que se pueden notar con respecto a la <em>API key</em>: no puede tener espacios al principio o al final, por lo que debería fallar si se intenta enviar &quot;&nbsp;&nbsp;&nbsp;&quot; por ejemplo como argumento, y que es posible modificar el valor de la <em>API key</em> utilizando la propiedad expuesta. Siguiendo los pasos anteriores:</p>
        <ol>
            <li>Se crea la prueba unitaria que valide que ningún valor consistente en espacios únicamente pueda ser aceptado</li>
            <li>Se implementa el código para hacerlo</li>
            <li>Se refactorea la clase <em>Clima</em> para transformar la propiedad en sólo lectura</li>
        </ol>

        <div class="source-code-header">clima_test.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">test_constructor_con_una_apikey_en_blanco_deberia_lanzar_valueerror</span>(<span class="cyan">self</span>):
            <span class="magenta">with</span> <span class="blue">self</span>.assertRaises(<span class="emerald">ValueError</span>) <span class="magenta">as</span> ve:
                sut = clima.Clima(<span class="orange">&quot;&nbsp;&nbsp;&nbsp;&nbsp;&quot;</span>)
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py 
F..
======================================================================
FAIL: test_constructor_con_una_apikey_en_blanco_deberia_lanzar_valueerror (__main__.ClimaUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;clima_test.py&quot;, line 17, in test_constructor_con_una_apikey_en_blanco_deberia_lanzar_valueerror
    sut = clima.Clima(&quot;&nbsp;&nbsp;&nbsp;&nbsp;&quot;)
AssertionError: ValueError not raised

----------------------------------------------------------------------
Ran 3 tests in 0.001s

FAILED (failures=1)
</pre>

        <div class="source-code-header">clima.py</div>
        <pre class="source-code full-listing">
<span class="blue">class</span> <span class="emerald">Clima</span>:
    <span class="blue">def</span> <span class="yellow">__init__</span>(<span class="cyan">self</span>, <span class="cyan">apikey</span>: <span class="emerald">str</span>):
        <span class="blue">self</span>.__apikey = apikey.strip()

        <span class="magenta">if</span> <span class="blue">self</span>.__apikey == <span class="orange">&quot;&quot;</span>:
            <span class="magenta">raise</span> <span class="emerald">ValueError</span>()

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">apikey</span>(<span class="cyan">self</span>) -&gt; <span class="emerald">str</span>:
        <span class="magenta">return</span> <span class="blue">self</span>.__apikey
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py 
...
----------------------------------------------------------------------
Ran 3 tests in 0.000s

OK
</pre>
        <p>Pero se ha introducido un posible problema: al pasar <em>None</em> como argumento habrá una excepción ya que se intentará ejecutar <em>strip</em> en un objeto nulo, por lo que se debe agregar una nueva prueba que verifique que <em>None</em> no sea aceptado.</p>

        <div class="source-code-header">clima_test.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">test_constructor_con_none_deberia_lanzar_valueerror</span>(<span class="cyan">self</span>):
        <span class="magenta">with</span> <span class="blue">self</span>.assertRaises(<span class="emerald">ValueError</span>) <span class="magenta">as</span> ve:
            sut = clima.Clima(<span class="blue">None</span>)
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py 
E...
======================================================================
ERROR: test_constructor_con_none_deberia_lanzar_valueerror (__main__.ClimaUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;clima_test.py&quot;, line 21, in test_constructor_con_none_deberia_lanzar_valueerror
    sut = clima.Clima(None)
  File &quot;/home/usuario/src/python/clima/clima.py&quot;, line 3, in __init__
    self.__apikey = apikey.strip()
AttributeError: 'NoneType' object has no attribute 'strip'

----------------------------------------------------------------------
Ran 4 tests in 0.000s

FAILED (errors=1)
</pre>

        <p>La implementación más sencilla del constructor para que la prueba unitaria pase podría ser la siguiente:</p>

        <div class="source-code-header">clima.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">__init__</span>(<span class="cyan">self</span>, <span class="cyan">apikey</span>: <span class="emerald">str</span>):
        <span class="magenta">if</span> apikey == <span class="blue">None</span>:
            <span class="magenta">raise</span> <span class="emerald">ValueError</span>()

        <span class="blue">self</span>.__apikey = apikey.strip()

        <span class="magenta">if</span> <span class="blue">self</span>.__apikey == <span class="orange">&quot;&quot;</span>:
            <span class="magenta">raise</span> <span class="emerald">ValueError</span>()
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py 
....
----------------------------------------------------------------------
Ran 4 tests in 0.000s

OK
</pre>

        <p>Ahora bien, el código del constructor puede ser pulido un poco más por lo que se aprovecha la etapa de refactorización para hacerlo.</p>

        <div class="source-code-header">clima.py</div>
        <pre class="source-code full-listing">
<span class="blue">class</span> <span class="emerald">Clima</span>:
    <span class="blue">def</span> <span class="yellow">__init__</span>(<span class="cyan">self</span>, <span class="cyan">apikey</span>: <span class="emerald">str</span>):
        <span class="blue">self</span>.__apikey = apikey.strip() <span class="magenta">if</span> apikey <span class="blue">is not None</span> <span class="magenta">else</span> <span class="orange">&quot;&quot;</span>
        <span class="magenta">if</span> <span class="blue">self</span>.__apikey == <span class="orange">&quot;&quot;</span>:
            <span class="magenta">raise</span> <span class="emerald">ValueErro</span>r()

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">apikey</span>(<span class="cyan">self</span>) -&gt; <span class="emerald">str</span>:
        <span class="magenta">return</span> <span class="blue">self</span>.__apikey
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py
....
----------------------------------------------------------------------
Ran 4 tests in 0.000s

OK
</pre>

        <p>Lo importante es priorizar la solución más simple posible que cubra exactamente la prueba unitaria ya que cada una debe enfocarse en un único aspecto del programa. No se debe codificar de más ni intentar avanzar más de lo que la prueba realmente requiera.</p>
        <p>Algo más que se puede apreciar es que, a medida que se avanza en el desarrollo del software, se van acumulando las pruebas que deben validar. Esto permite conocer inmediatamente cuando una nueva funcionalidad ha hecho que otra ya existente deje de funcionar. Aunque no de manera tan estricta como en <em>BDD</em> (<em>behaviour-driven development</em>, <a href="https://es.wikipedia.org/wiki/Desarrollo_guiado_por_comportamiento">desarrollo guiado por comportamiento</a>, donde todas las pruebas son representaciones de especificaciones), las pruebas en <em>TDD</em> son guías de cómo debería funcionar el software, por consiguiente mientras más pormenorizadas mejor.</p>

        <p>Para empezar la comunicación entre la aplicación y el servidor es necesario el nombre de la ciudad. Para ello se agrega un nuevo argumento a la clase <em>Clima</em> y se la guarda dentro de una propiedad que será de lectura únicamente (similar a la propiedad <em>API key</em>):</p>

        <div class="source-code-header">clima_test.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">test_constructor_con_ciudad_valida_deberia_incorporarla</span>(<span class="cyan">self</span>):
        ciudad = <span class="orange">&quot;London&quot;</span>
        apikey = <span class="orange">&quot;abcdefg&quot;</span>

        sut = clima.Clima(apikey, ciudad)
        <span class="blue">self</span>.assertEqual(ciudad, sut.ciudad)
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py 
E....
======================================================================
ERROR: test_constructor_con_ciudad_valida_deberia_incorporarla (__main__.ClimaUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;clima_test.py&quot;, line 27, in test_constructor_con_ciudad_valida_deberia_incorporarla
    sut = clima.Clima(apikey, ciudad)
TypeError: __init__() takes 2 positional arguments but 3 were given

----------------------------------------------------------------------
Ran 5 tests in 0.000s

FAILED (errors=1)
</pre>

        <p>Sin embargo, al implementar la solución más simple se apreciará que, aunque la última prueba funcionará correctamente, las demás dejarán de funcionar.</p>

        <div class="source-code-header">clima.py</div>
        <pre class="source-code full-listing">
<span class="blue">class</span> <span class="emerald">Clima</span>:
    <span class="blue">def</span> <span class="yellow">__init__</span>(<span class="cyan">self</span>, <span class="cyan">apikey</span>: <span class="emerald">str</span>, <span class="cyan">ciudad</span>: <span class="emerald">str</span>):
        <span class="blue">self</span>.__apikey = apikey.strip() <span class="magenta">if</span> apikey <span class="blue">is not None</span> <span class="magenta">else</span> <span class="orange">&quot;&quot;</span>
        <span class="magenta">if</span> <span class="blue">self</span>.__apikey == <span class="orange">&quot;&quot;</span>:
            <span class="magenta">raise</span> <span class="emerald">ValueErro</span>r()

        <span class="blue">self</span>.__ciudad = ciudad

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">apikey</span>(<span class="cyan">self</span>) -&gt; <span class="emerald">str</span>:
        <span class="magenta">return</span> <span class="blue">self</span>.__apikey

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">ciudad</span>(<span class="cyan">self</span>) -&gt; <span class="emerald">str</span>:
        <span class="magenta">return</span> <span class="blue">self</span>.__ciudad
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py 
.EEEE
======================================================================
ERROR: test_constructor_con_none_deberia_lanzar_valueerror (__main__.ClimaUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;clima_test.py&quot;, line 21, in test_constructor_con_none_deberia_lanzar_valueerror
    sut = clima.Clima(None)
TypeError: __init__() missing 1 required positional argument: 'ciudad'

======================================================================
ERROR: test_constructor_con_una_apikey_en_blanco_deberia_lanzar_valueerror (__main__.ClimaUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;clima_test.py&quot;, line 17, in test_constructor_con_una_apikey_en_blanco_deberia_lanzar_valueerror
    sut = clima.Clima(&quot;&nbsp;&nbsp;&nbsp;&nbsp;&quot;)
TypeError: __init__() missing 1 required positional argument: 'ciudad'

======================================================================
ERROR: test_constructor_con_una_apikey_vacia_deberia_lanzar_valueerror (__main__.ClimaUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;clima_test.py&quot;, line 13, in test_constructor_con_una_apikey_vacia_deberia_lanzar_valueerror
    sut = clima.Clima(&quot;&quot;)
TypeError: __init__() missing 1 required positional argument: 'ciudad'

======================================================================
ERROR: test_constructor_con_una_apikey_valida_deberia_incorporarla (__main__.ClimaUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;clima_test.py&quot;, line 8, in test_constructor_con_una_apikey_valida_deberia_incorporarla
    sut = clima.Clima(apikey)
TypeError: __init__() missing 1 required positional argument: 'ciudad'

----------------------------------------------------------------------
Ran 5 tests in 0.000s

FAILED (errors=4)
</pre>

        <p>Al agregar un nuevo argumento obligatorio al constructor (en este caso, la ciudad), las cuatro pruebas unitarias anteriores que únicamente especificaban la <em>API key</em> automáticamente dejan de funcionar hasta que sean actualizadas. Esta situación se volverá a repetir ya que se necesitan agregar más parámetros (por ejemplo, el lenguaje de la respuesta).</p>

        <h2 id="builderpattern">Patrón del constructor o <em>builder pattern</em></h2>
        <p>Para solucionar este problema se implementará un <a href="https://es.wikipedia.org/wiki/Patr%C3%B3n_de_dise%C3%B1o">patrón de diseño</a> específico, el <a href="https://es.wikipedia.org/wiki/Builder_(patr%C3%B3n_de_dise%C3%B1o)"><em>builder</em> o Constructor</a> (no confundir con el método <em>constructor</em> de una clase). Este patrón requiere la creación de una clase <em>ClimaBuilder</em> que permitirá crear un objeto <em>Clima</em> mientras oculta los parámetros obligatorios de su constructor de manera que no sea necesario modificar cada una de las pruebas unitarias al agregar nuevos parámetros al constructor de la clase.</p>

        <div class="source-code-header">climabuilder_test.py</div>
        <pre class="source-code full-listing">
<span class="magenta">import</span> unittest
<span class="magenta">from</span> clima <span class="magenta">import</span> Clima
<span class="magenta">from</span> climabuilder <span class="magenta">import</span> ClimaBuilder

<span class="blue">class</span> <span class="emerald">ClimaBuilderUnitTests</span>(<span class="emerald">unittest</span>.<span class="emerald">TestCase</span>):
    <span class="blue">def</span> <span class="yellow">test_con_apikey_con_una_apikey_valida_deberia_incorporarla</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        apikey = <span class="orange">&quot;abcdefg&quot;</span>

        <span class="green"># Act</span>
        builder = ClimaBuilder().con_apikey(apikey)

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(apikey, builder.apikey)

    <span class="blue">def</span> <span class="yellow">test_con_ciudad_con_una_ciudad_valida_deberia_incorporarla</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        ciudad = <span class="orange">&quot;London&quot;</span>

        <span class="green"># Act</span>
        builder = ClimaBuilder().con_ciudad(ciudad)

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(ciudad, builder.ciudad)

    <span class="blue">def</span> <span class="yellow">test_constructor_con_valor_por_defecto_deberia_ser_BsAs_y_apikey_nulo</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        ciudad = <span class="orange">&quot;Buenos%20Aires&quot;</span>

        <span class="green"># Act</span>
        builder = ClimaBuilder()

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertIsNone(builder.apikey)
        <span class="blue">self</span>.assertEqual(ciudad, builder.ciudad)

<span class="magenta">if</span> <span class="cyan">__name__</span> == <span class="orange">&quot;__main__&quot;</span>:
    unittest.main()
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 climabuilder_test.py
Traceback (most recent call last):
  File &quot;climabuilder_test.py&quot;, line 3, in &lt;module&gt;
    from climabuilder import ClimaBuilder
ModuleNotFoundError: No module named 'climabuilder'
</pre>
        <p>Nótese que estrictamente hablando se debería avanzar de a un método por vez, sin embargo es posible dar saltos siempre y cuando se tenga la experiencia suficiente como para anticipar posibles errores. En este caso, por una cuestión de brevedad, se muestra la totalidad de las pruebas de una vez.</p>

        <p>A partir de este momento se debería crear primero una instancia de <em>ClimaBuilder</em>, definir la <em>API key</em> utilizando el método <em>con_apikey</em>, y luego indicar la ciudad con el método <em>con_ciudad</em>. Esos métodos son básicamente <em>setters</em>, guardando el valor en un atributo y retornando una referencia a sí mismo. Esto permite encadenar las llamadas de configuración una tras otra en una única expresión en lugar de tener una sentencia por cada <em>setter</em>. Finalmente una llamada al método <em>build</em> pasará todos los parámetros acumulados al constructor de <em>Clima</em>. Este patrón de dise&ntilde;o es ampliamente usado para &quot;humanizar&quot;, para incorporar lenguaje natural al programar (además del patrón <em>builder</em>, es común ver la &quot;humanización&quot; con las aseveraciones tipo <em>assert</em> durante las pruebas unitarias, como por ejemplo en <a href="https://github.com/csparpa/fluentcheck">Fluent Check</a> en Python o <a href="https://fluentassertions.com/introduction">Fluent Assertions</a> en .NET).</p>
      
        <p>La prueba unitaria sólo verifica que el <em>builder</em> conserve los valores y los envíe al constructor de la clase que está creando correctamente, nada más. Por ejemplo, si en esta implementación se decidiese verificar que la <em>API key</em> sea válida (en otras palabras, que no esté vacía ni que sea nula) se utilizaría exactamente el mismo código que ya existe en el constructor de la clase <em>Clima</em>.</p>

        <p>A continuación, la creación del <em>ClimaBuilder</em>.</p>

        <div class="source-code-header">climabuilder.py</div>
        <pre class="source-code full-listing">
<span class="magenta">from</span> clima <span class="magenta">import</span> Clima

<span class="blue">class</span> <span class="emerald">ClimaBuilder</span>:
    <span class="blue">def</span> <span class="yellow">__init__</span>(<span class="cyan">self</span>):
        <span class="blue">self</span>.__apikey = <span class="blue">None</span>
        <span class="blue">self</span>.__ciudad = <span class="orange">&quot;Buenos%20Aires&quot;</span>

    <span class="blue">def</span> <span class="yellow">con_apikey</span>(<span class="cyan">self</span>, <span class="cyan">apikey</span>: <span class="emerald">str</span>):
        <span class="blue">self</span>.__apikey = apikey
        <span class="magenta">return</span> <span class="blue">self</span>

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">apikey</span>(<span class="cyan">self</span>) -&gt; <span class="emerald">str</span>:
        <span class="magenta">return</span> <span class="blue">self</span>.__apikey

    <span class="blue">def</span> <span class="yellow">con_ciudad</span>(<span class="cyan">self</span>, <span class="cyan">ciudad</span>: <span class="emerald">str</span>):
        <span class="blue">self</span>.__ciudad = ciudad
        <span class="magenta">return</span> <span class="blue">self</span> 

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">ciudad</span>(<span class="cyan">self</span>) -&gt; <span class="emerald">str</span>:
        <span class="magenta">return</span> <span class="blue">self</span>.__ciudad

    <span class="blue">def</span> <span class="yellow">build</span>(<span class="cyan">self</span>):
        <span class="magenta">return</span> Clima(<span class="blue">self</span>.__apikey, <span class="blue">self</span>.__ciudad)
</pre>

       <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 climabuilder_test.py 
...
----------------------------------------------------------------------
Ran 3 tests in 0.000s

OK
</pre>

<p>Cabe destacar que el constructor de <em>ClimaBuilder</em> define una ciudad por defecto, &quot;Buenos Aires&quot;. <em>%20</em> es la codificación hexadecimal de un espacio y es la forma en la que se envía a través de una <em>url</em> o dirección de internet. Por otro lado no existe una <em>API key</em> por defecto, por consiguiente será obligatoria indicarla cada vez que se quiera construir una instancia de <em>Clima</em>.</p>

        <h2 id="inyeccion">Inyección de dependencias</h2>

        <p>La <a href="https://es.wikipedia.org/wiki/Inyecci%C3%B3n_de_dependencias">inyección de dependencias</a> es la consecuencia de uno de los cinco principios fundamentales de la programación orientada a objetos moderna conocidos como <a href="https://es.wikipedia.org/wiki/SOLID">S.O.L.I.D</a>. La &quot;D&quot; del acrónimo, que representa al principio de inversión de la dependencia indica que se debe depender de abstracciones y no de implementaciones, por ejemplo, si un objeto necesita crear una instancia de otro para poder realizar su procesamiento el patrón sugiere que se acepte la instanciación concreta de dicho objeto desde el exterior, mientras que internamente se la referencie con una interface. De esta manera será posible modificar el funcionamiento de la clase sin tener que modificarla (insidentalmente la &quot;O&quot; del acrónimo, <a href="https://es.wikipedia.org/wiki/Principio_de_abierto/cerrado">principio de abierto/cerrado</a>, se refiere a que las clases deben estar cerradas a modificaciones pero abiertas a extensiones).</p>
        <p>Para poder verificar que el método <em>build</em> envía los parámetros correctos en el orden indicado al constructor se debe modificar <em>ClimaBuilder</em> para permitir la &quot;inyección&quot;. Idealmente se debería recibir un <a href="https://es.wikipedia.org/wiki/Factory_Method_(patr%C3%B3n_de_dise%C3%B1o)">factory</a> que construya el objeto que se va a necesitar, sin embargo en este caso en específico alcanza con crear un método privado que reciba los mismos parámetros que el constructor de la clase <em>Clima</em> para crear instancia:</p>

        <div class="source-code-header">climabuilder.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">_crear_clima</span>(<span class="cyan">self</span>, <span class="cyan">apikey</span>: <span class="emerald">str</span>, <span class="cyan">ciudad</span>: <span class="emerald">str</span>) -&gt; Clima:
        <span class="magenta">return</span> Clima(apikey, ciudad)

    <span class="blue">def</span> <span class="yellow">build</span>(<span class="cyan">self</span>):
        <span class="magenta">return</span> <span class="blue">self</span>._crear_clima(<span class="blue">self</span>.__apikey, <span class="blue">self</span>.__ciudad)
</pre>

       <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 climabuilder_test.py 
...
----------------------------------------------------------------------
Ran 3 tests in 0.000s

OK
</pre>

        <p>Una vez verificado que las pruebas unitarias siguen pasando es posible agregar una nueva prueba que utilice un <em>mock</em> u <a href="https://es.wikipedia.org/wiki/Objeto_simulado">objeto simulado</a> para verificar que los datos enviados sean los correctos. Para ello se importa <em>patch</em> del módulo <em>unittest.mock</em> en la parte superior de <em>climabuilder_test.py</em>...</p>

        <div class="source-code-header">climabuilder_test.py</div>
        <pre class="source-code partial-listing">
<span class="magenta">from</span> unittest.mock <span class="magenta">import</span> patch
</pre>

<p>...para luego agregar la nueva prueba:</p>

        <div class="source-code-header">climabuilder_test.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">test_build_con_valores_deberia_crearlo_con_ellos</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        apikey = <span class="orange">&quot;123abc&quot;</span>
        ciudad = <span class="orange">&quot;Sydney&quot;</span>

        <span class="magenta">with</span> patch.object(ClimaBuilder, <span class="orange">'_crear_clima'</span>, <span class="cyan">return_value</span>=<span class="blue">None</span>) <span class="magenta">as</span> mock_method:
            clima = ClimaBuilder().con_apikey(apikey).con_ciudad(ciudad).build()

            <span class="blue">self</span>.assertIsNone(clima)
            mock_method.assert_called_once_with(apikey, ciudad)
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 climabuilder_test.py 
....
----------------------------------------------------------------------
Ran 4 tests in 0.000s

OK
</pre>

        <p>Con <a href="https://docs.python.org/2.5/whatsnew/pep-343.html">with</a> se crea un contexto en donde cualquier instancia nueva de <em>ClimaBuilder</em> va a tener su método <em>_crear_clima</em> reemplazado por uno falso o simulado que retornará <em>None</em>. Dentro de ese contexto se crea la instancia de <em>Clima</em> y se realizan dos verificaciones: que el valor retornado sea <em>None</em> (aunque no es necesario) y se verifica que el método simulado fue invocado una única vez con los valores de la <em>API key</em> y &quot;Sydney&quot;, en ese orden.

        <p>Ya con el <em>builder</em> creado y probado es posible refactorear las pruebas unitarias en <em>clima_test.py</em> para utilizarlo y evitar que vuelvan a fallar al agregar nuevos parámetros al constructor de <em>Clima</em>.</p>

        <div class="source-code-header">clima_test.py</div>
        <pre class="source-code full-listing">
<span class="magenta">import</span> unittest
<span class="magenta">from</span> climabuilder <span class="magenta">import</span> ClimaBuilder
<span class="magenta">from</span> clima <span class="magenta">import</span> Clima

<span class="blue">class</span> <span class="emerald">ClimaUnitTests</span>(<span class="emerald">unittest</span>.<span class="emerald">TestCase</span>):
    <span class="blue">def</span> <span class="yellow">test_constructor_con_una_apikey_valida_deberia_incorporarla</span>(<span class="cyan">sel</span>f):
        apikey = <span class="orange">&quot;abcdefg&quot;</span>

        sut = ClimaBuilder().con_apikey(apikey).build()

        <span class="blue">self</span>.assertEqual(apikey, sut.apikey)

    <span class="blue">def</span> <span class="yellow">test_constructor_con_una_apikey_vacia_deberia_lanzar_valueerror</span>(<span class="cyan">self</span>):
        <span class="magenta">with</span> <span class="blue">self</span>.assertRaises(<span class="emerald">ValueError</span>) <span class="magenta">as</span> ve:
            sut = ClimaBuilder().con_apikey(<span class="orange">&quot;&quot;</span>).build()

    <span class="blue">def</span> <span class="yellow">test_constructor_con_una_apikey_en_blanco_deberia_lanzar_valueerror</span>(<span class="cyan">self</span>):
        <span class="magenta">with</span> <span class="blue">self</span>.assertRaises(<span class="emerald">ValueError</span>) <span class="magenta">as</span> ve:
            sut = ClimaBuilder().con_apikey(<span class="orange">&quot;&nbsp;&nbsp;&nbsp;&nbsp;&quot;</span>).build()

    <span class="blue">def</span> <span class="yellow">test_constructor_con_none_deberia_lanzar_valueerror</span>(<span class="cyan">self</span>):
        <span class="magenta">with</span> <span class="blue">self</span>.assertRaises(<span class="emerald">ValueError</span>) <span class="magenta">as</span> ve:
            sut = ClimaBuilder().con_apikey(<span class="blue">None</span>).build()

    <span class="blue">def</span> <span class="yellow">test_constructor_con_ciudad_valida_deberia_incorporarla</span>(<span class="magenta">self</span>):
        ciudad = <span class="orange">&quot;London&quot;</span>
        apikey = <span class="orange">&quot;abcdefg&quot;</span>

        sut = ClimaBuilder().con_apikey(apikey).con_ciudad(ciudad).build()
        <span class="blue">self</span>.assertEqual(ciudad, sut.ciudad)

<span class="magenta">if</span> <span class="cyan">__name__</span> == <span class="orange">&quot;__main__&quot;</span>:
    unittest.main()
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py 
.....
----------------------------------------------------------------------
Ran 5 tests in 0.000s

OK
</pre>
        <p>Cabe destacar que si no existiesen las pruebas unitarias de <em>ClimaBuilder</em> se podría considerar que las pruebas unitarias en <em>clima_test.py</em> no son del todo correctas ya que estarían probando tanto que se pueda crear un objeto de <em>ClimaBuilder</em>, que los métodos <em>con_apikey</em> y <em>con_ciudad</em> estén guardando los datos dentro de los atributos correctos y que el método <em>build</em> esté pasando la información de forma correcta a la instancia de la clase <em>Clima</em>. Esto se asemeja más a una <em>prueba de integración</em>, la cual será explicada en una sección posterior.</p>

        <h2 id="detroitlondres">Detroit vs Londres</h2>

        <p>En la última prueba se verificó que el resultado fuese nulo y que se haya llamado a <em>_crear_clima</em> con determinados valores, exponiendo las dos escuelas que existen en <em>TDD</em>: la Detroit (o clásica) y la escuela Londres (o <em>mockist</em>, literalmente &quot;burlones&quot; pero en este contexto, &quot;simuladores&quot;). La escuela clásica indica que únicamente se deben verificar los resultados: si el resultado es correcto se asume que el funcionamiento también. La escuela londinense indica que es necesario verificar que la mensajería entre los objetos sea la correcta, no tanto el resultado: de nada sirve llegar al resultado correcto si se llaman funciones que no son necesarias o si se las utiliza en el orden incorrecto. A eso que tiene sentido la escuela clásica contrapone que verificar el funcionamiento interno de un objeto fomenta el acoplamiento, ya que si se modificase la función que se utiliza internamente por reorganización de código sería necesario modificar las pruebas cuando con su planteo no deberían hacerlo.</p>

        <p>Existe cuatro tipos de objetos &quot;dobles&quot; (como en &quot;doble de película de acción&quot;) que ayudan en la ejecución de pruebas. De esos cuatro hay dos, los bobos (o <em>dummies</em>) que no ejecutan lógica ni devuelven nada y los <em>stubs</em> que no ejecutan lógica pero devuelven valores predeterminados son los preferidos del estilo Detroit. Implican que se deben escribir clases extras que implementan las interfaces y mediante inyección de dependencias se las proveen a los objetos siendo testeados. Los otros dos tipos de dobles verifican interacciones y son los preferidos de la escuela londinense: los espías y los <em>mocks</em>. Los espías son <em>stubs</em> que graban determinada información, por ejemplo, los argumentos que fueron dados a los métodos, la cantidad de veces que cada método se llamó y el orden en que se llamaron, por ejemplo. Finalmente los <em>mocks</em> son espías que pueden verificar en tiempo real las llamadas y lanzar una excepción si se llamó con diferentes argumentos, o si se llama más de una vez.</p>

        <p>Muchos <em>frameworks</em> de pruebas unitarias llaman a cualquiera de esos cuatro tipos <em>mocks</em> pero permite configurar si se desea que no haga nada (como un <em>dummy</em>), que retorne un valor predeterminado (como un <em>stub</em>), que recuerde datos sobre la interacción (como los espías) o si se desea que lance una excepción tan pronto como algo que no estaba planeado pase (como un <em>mock</em> literal).</p>

        <p>Como siempre es preferible permanecer agnóstico: mientras que la mayoría de las pruebas pueden seguir el estilo Detroit, existen casos donde el estilo londinense es preferible.</p>

        <h2 id="tdd">Test dirigido por datos</h2>

        <p>En las pruebas unitarias de <em>ClimaBuilder</em>, hasta ahora existía algo así:</p>

        <div class="source-code-header">climabuilder_test.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">test_con_ciudad_con_una_ciudad_valida_deberia_incorporarla</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        ciudad = <span class="orange">&quot;London&quot;</span>

        <span class="green"># Act</span>
        builder = ClimaBuilder().con_ciudad(ciudad)

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(ciudad, builder.ciudad)
</pre>

        <p>Sin embargo, el nombre del método no es del todo correcto: Como los métodos de <em>ClimaBuilder</em> son simples <em>setters</em>, deberían aceptar cualquier valor, sea éste válido o inválido. Una opción sería crear una nueva prueba por cada valor inválido, por ejemplo:</p>

        <div class="source-code-header">climabuilder_test.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">test_con_ciudad_con_una_ciudad_nula_deberia_incorporarla</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        ciudad = <span class="blue">None</span>

        <span class="green"># Act</span>
        builder = ClimaBuilder().con_ciudad(ciudad)

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(ciudad, builder.ciudad)

    <span class="blue">def</span> <span class="yellow">test_con_ciudad_con_una_ciudad_vacia_deberia_incorporarla</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        ciudad = <span class="orange">&quot;&quot;</span>

        <span class="green"># Act</span>
        builder = ClimaBuilder().con_ciudad(ciudad)

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(ciudad, builder.ciudad)
</pre>

        <p>Pero además deberíamos armar una prueba para &quot;&nbsp;&quot; (que también es vacío), o &quot;&nbsp;&nbsp;&nbsp;&quot;, o tal vez números en lugar de un nombre, etc. Es posible llegar a considerar recorrer una lista con los valores inválidos, realizando una verificación por cada iteración:</p>

        <div class="source-code-header">climabuilder_test.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">test_con_ciudad_con_una_ciudad_invalida_deberia_incorporarla</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        ciudades = [ <span class="blue">None</span>, <span class="orange">&quot;&quot;</span>, <span class="orange">&quot;&nbsp;&quot;</span>, <span class="orange">&quot;&nbsp;&nbsp;&nbsp;&nbsp;&quot;</span>, <span class="orange">&quot;\t&quot;</span> ]

        <span class="green"># Act</span>
        <span class="magenta">for</span> ciudad <span class="blue">in</span> ciudades:
            builder = ClimaBuilder().con_ciudad(ciudad)

            <span class="green"># Assert</span>
            <span class="blue">self</span>.assertEqual(ciudad, builder.ciudad)
</pre>

        <p>pero se estarían realizando varios actos y verificaciones en una única prueba cuando debería ser un único acto, además de que si cada prueba necesitara una inicialización (usualmente un código que debe ejecutarse antes y/o después de cada prueba) dicho código sólo se ejecutaría una vez por prueba. Para evitar estos problemas es posible utilizar la librería <a href="https://ddt.readthedocs.io/en/latest/">ddt</a> (<em>Data-driven Tests</em>, o pruebas guiadas por datos) para &quot;alimentar&quot; con datos a cada prueba. Primero es necesario instalar el módulo con <span class="command-line">pip3 install ddt</span>, luego importarlo y utilizar el decorador <em>@ddt</em> en la clase de prueba:</p>

        <div class="source-code-header">climabuilder_test.py</div>
        <pre class="source-code partial-listing">
<span class="magenta">import</span> unittest
<span class="magenta">from</span> ddt <span class="magenta">import</span> ddt, data
<span class="magenta">from</span> unittest.mock <span class="magenta">import</span> patch
<span class="magenta">from</span> clima <span class="magenta">import</span> Clima
<span class="magenta">from</span> climabuilder <span class="magenta">import</span> ClimaBuilder

<span class="yellow">@ddt</span>
<span class="blue">class</span> <span class="emerald">ClimaBuilderUnitTests</span>(<span class="emerald">unittest</span>.<span class="emerald">TestCase</span>):
</pre>

        <p>y el decorador <em>@data</em> en el método junto con los distintos valores que alimentarán al metodo de prueba. Finalmente, para que este último los incorpore es necesario agregar un parámetro nuevo para recibirlo en el método de prueba:</p>

        <div class="source-code-header">climabuilder_test.py</div>
        <pre class="source-code partial-listing">
    <span class="yellow">@data</span>(<span class="blue">None</span>, <span class="orange">&quot;&quot;</span>, <span class="orange">&quot;&nbsp;&nbsp;&nbsp;&nbsp;&quot;</span>, <span class="orange">&quot;abcdefg&quot;</span>)
    <span class="blue">def</span> <span class="yellow">test_con_ciudad_con_cualquier_ciudad_deberia_incorporarla</span>(<span class="cyan">self</span>, <span class="cyan">ciudad</span>: <span class="emerald">str</span>):
        <span class="green"># Act</span>
        builder = ClimaBuilder().con_ciudad(ciudad)

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(ciudad, builder.ciudad)
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py 
........
----------------------------------------------------------------------
Ran 8 tests in 0.000s

OK
</pre>

        <p>Sabiendo como utilizar <em>@ddt</em> es posible escribir las pruebas unitarias para cada uno de los parámetros que se pueden enviar a la <em>API.</em></p>
        <p>En la página de <em>OpenWeather</em> se indica que además de la ciudad es posible enviar como argumentos el país, la unidad de temperatura, o en lugar del nombre de la ciudad es posible pasar el id de la misma, o sus coordenadas.</p>
        <p>En este momento es posible refactorear los métodos de prueba existentes para que utilicen <em>@data</em> y, al mismo tiempo, eliminar <em class="breakable-word">test_con_ciudad_con_una_ciudad_valida_deberia_incorporarla</em> ya que su caso ahora será probado por <em class="breakable-word">test_con_ciudad_con_cualquier_ciudad_deberia_incorporarla</em>. Una de las ventajas de tener nombres descriptivos es saber si la funcionalidad de un método esta repetida en otro con sólo leerlo.</p>

        <div class="source-code-header">climabuilder_test.py</div>
        <pre class="source-code partial-listing">
<span class="magenta">import</span> unittest
<span class="magenta">from</span> unittest.mock <span class="magenta">import</span> patch
<span class="magenta">from</span> ddt <span class="magenta">import</span> ddt, data, unpack
<span class="magenta">from</span> clima <span class="magenta">import</span> Clima
<span class="magenta">from</span> climabuilder <span class="magenta">import</span> ClimaBuilder

<span class="yellow">@ddt</span>
<span class="blue">class</span> <span class="emerald">ClimaBuilderUnitTests</span>(<span class="emerald">unittest</span>.<span class="emerald">TestCase</span>):

    <span class="yellow">@data</span>(<span class="blue">None</span>, <span class="orange">&quot;&quot;</span>, <span class="orange">&quot;&nbsp;&nbsp;&quot;</span>, <span class="orange">&quot;abcdefg&quot;</span>)
    <span class="blue">def</span> <span class="yellow">test_con_apikey_con_cualquier_apikey_deberia_incorporarla</span>(<span class="cyan">self</span>, <span class="cyan">cualquier_apikey</span>: <span class="emerald">str</span>):
        <span class="green"># Arrange / Act</span>
        builder = ClimaBuilder().con_apikey(cualquier_apikey)

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(cualquier_apikey, builder.apikey)

    <span class="yellow">@data</span>(<span class="blue">None</span>, <span class="orange">&quot;&quot;</span>, <span class="orange">&quot;&nbsp;&nbsp;&quot;</span>, <span class="orange">&quot;abcdefg&quot;</span>)
    <span class="blue">def</span> <span class="yellow">test_con_ciudad_con_cualquier_ciudad_deberia_incorporarla</span>(<span class="cyan">self</span>, <span class="cyan">cualquier_ciudad</span>: <span class="emerald">str</span>):
        <span class="green"># Arrange / Act</span>
        builder = ClimaBuilder().con_ciudad(cualquier_ciudad)

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(cualquier_ciudad, builder.ciudad)

    <span class="yellow">@data</span>(<span class="blue">None</span>, <span class="orange">&quot;&quot;</span>, <span class="orange">&quot;&nbsp;&nbsp;&quot;</span>, <span class="orange">&quot;abcdefg&quot;</span>)
    <span class="blue">def</span> <span class="yellow">test_en_pais_con_cualquier_pais_deberia_incorporarlo</span>(<span class="cyan">self</span>, <span class="cyan">cualquier_pais</span>: <span class="emerald">str</span>):
        <span class="green"># Arrange / Act</span>
        builder = ClimaBuilder().en_pais(cualquier_pais)

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(cualquier_pais, builder.pais)

    <span class="yellow">@data</span>(<span class="blue">None</span>, <span class="orange">&quot;&quot;</span>, <span class="orange">&quot;&nbsp;&nbsp;&quot;</span>, <span class="orange">&quot;abcdefg&quot;</span>)
    <span class="blue">def</span> <span class="yellow">test_en_codigo_postal_con_cualquier_codigo_postal_deberia_aceptarlo</span>(<span class="cyan">self</span>, <span class="cyan">cualquier_codigo_postal</span>: <span class="emerald">str</span>):
        <span class="green"># Arrange / Act</span>
        builder = ClimaBuilder().en_codigo_postal(cualquier_codigo_postal)

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(cualquier_codigo_postal, builder.codigo_postal)

    <span class="yellow">@data</span>((<span class="gold">0</span>, <span class="gold">0</span>), (<span class="gold">-1</span>, <span class="gold">10</span>), (<span class="gold">13</span>, <span class="gold">-1</span>), (<span class="gold">-8</span>, <span class="gold">-6</span>))
    <span class="yellow">@unpack</span>
    <span class="blue">def</span> <span class="yellow">test_en_coordenadas_con_cualquier_coordenada_deberia_incorporarla</span>(<span class="cyan">self</span>, <span class="cyan">cualquier_latitud</span>: <span class="emerald">float</span>, <span class="cyan">cualquier_longitud</span>: <span class="emerald">float</span>):
        <span class="green"># Arrange</span>
        cualquier_coordenada = (cualquier_latitud, cualquier_longitud)
        builder = ClimaBuilder()

        <span class="green"># Act</span>
        builder = builder.en_coordenadas(cualquier_latitud, cualquier_longitud)

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(cualquier_coordenada, builder.coordenadas)

    <span class="blue">def</span> <span class="yellow">test_en_fahrenheit_con_fahrenheit_flag_deberia_incorporarlo</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        builder = ClimaBuilder()

        <span class="green"># Act</span>
        builder = builder.en_fahrenheit()

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(<span class="orange">&quot;fahrenheit&quot;</span>, builder.grados)

    <span class="blue">def</span> <span class="yellow">test_en_celsius_con_celsius_flag_deberia_incorporarlo</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        builder = ClimaBuilder()

        <span class="green"># Act</span>
        builder.en_celsius()

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(<span class="orange">&quot;celsius&quot;</span>, builder.grados)

    <span class="blue">def</span> <span class="yellow">test_en_kelvin_con_kelvin_flag_deberia_incorporarlo</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        builder = ClimaBuilder()

        <span class="green"># Act</span>
        builder.en_kelvin()

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(<span class="orange">&quot;kelvin&quot;</span>, builder.grados)

    <span class="yellow">@data</span>(<span class="gold">-33</span>, <span class="gold">0</span>, <span class="gold">1</span>, <span class="gold">10</span>, <span class="gold">1000</span>)
    <span class="blue">def</span> <span class="yellow">test_con_id_con_cualquier_id_deberia_incorporarlo</span>(<span class="cyan">self</span>, <span class="cyan">cualquier_id</span>: <span class="emerald">int</span>):
        <span class="green"># Arrange</span>
        builder = ClimaBuilder()

        <span class="green"># Act</span>
        builder.con_id(cualquier_id)

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(cualquier_id, builder.id)

    <span class="yellow">@data</span>(<span class="orange">&quot;&quot;</span>, <span class="orange">&quot;&nbsp;&nbsp;&quot;</span>, <span class="orange">&quot;es&quot;</span>, <span class="orange">&quot;english&quot;</span>)
    <span class="blue">def</span> <span class="yellow">test_en_idioma_con_cualquier_idioma_deberia_incorporarlo</span>(<span class="cyan">self</span>, <span class="cyan">cualquier_idioma</span>: <span class="emerald">str</span>):
        <span class="green"># Arrange</span>
        builder = ClimaBuilder()

        <span class="green"># Act</span>
        builder.en_idioma(cualquier_idioma)

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(cualquier_idioma, builder.idioma)
</pre>

        <p>Hay un último método ya existente que debe ser modificado. El método que verifica los valores por defecto debe verificar también que los grados estén en <em>kelvin</em>, que el país sea Argentina y que el idioma sea inglés.</p>

        <div class="source-code-header">climabuilder_test.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">test_constructor_con_creacion_deberia_tener_idioma_ciudad_grados_pais</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        idioma = <span class="orange">&quot;en&quot;</span>
        ciudad = <span class="orange">&quot;Buenos%20Aires&quot;</span>
        pais = <span class="orange">&quot;ar&quot;</span>
        grados = <span class="orange">&quot;kelvin&quot;</span>

        <span class="green"># Act</span>
        builder = ClimaBuilder()

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(pais, builder.pais)
        <span class="blue">self</span>.assertEqual(ciudad, builder.ciudad)
        <span class="blue">self</span>.assertEqual(idioma, builder.idioma)
        <span class="blue">self</span>.assertEqual(grados, builder.grados)
</pre>

        <p>Si se intentase correr las pruebas en estos momentos habrían 25 errores sobre 33 pruebas. Con los casos de prueba listos para <em>ClimaBuilder</em> es posible implementarlo en <em>climabuilder.py</em>:

        <div class="source-code-header">climabuilder.py</div>
        <pre class="source-code full-listing">
<span class="magenta">from</span> clima <span class="magenta">import</span> Clima

<span class="blue">class</span> <span class="emerald">ClimaBuilder</span>:
    <span class="blue">def</span> <span class="yellow">__init__</span>(<span class="cyan">self</span>):
        <span class="blue">self</span>.__apikey = <span class="blue">None</span>
        <span class="blue">self</span>.__id = <span class="blue">None</span>
        <span class="blue">self</span>.__coordenadas = <span class="blue">None</span>
        <span class="blue">self</span>.__codigo_postal = <span class="blue">None</span>
        <span class="blue">self</span>.__grados = <span class="orange">&quot;kelvin&quot;</span>
        <span class="blue">self</span>.__pais = <span class="orange">&quot;ar&quot;</span>
        <span class="blue">self</span>.__ciudad = <span class="orange">&quot;Buenos%20Aires&quot;</span>
        <span class="blue">self</span>.__idioma = <span class="orange">&quot;en&quot;</span>

    <span class="blue">def</span> <span class="yellow">con_apikey</span>(<span class="cyan">self</span>, <span class="cyan">apikey</span>: <span class="emerald">str</span>):
        <span class="blue">self</span>.__apikey = apikey
        <span class="magenta">return</span> <span class="blue">self</span>

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">apikey</span>(<span class="cyan">self</span>) -&gt; <span class="emerald">str</span>:
        <span class="magenta">return</span> <span class="blue">self</span>.__apikey

    <span class="blue">def</span> <span class="yellow">con_ciudad</span>(<span class="cyan">self</span>, <span class="cyan">ciudad</span>: <span class="emerald">str</span>):
        <span class="blue">self</span>.__ciudad = ciudad
        <span class="magenta">return</span> <span class="blue">self</span>

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">ciudad</span>(<span class="cyan">self</span>) -&gt; <span class="emerald">str</span>:
        <span class="magenta">return</span> <span class="blue">self</span>.__ciudad

    <span class="blue">def</span> <span class="yellow">en_pais</span>(<span class="cyan">self</span>, <span class="cyan">pais</span>: <span class="emerald">str</span>):
        <span class="blue">self</span>.__pais = pais
        <span class="magenta">return</span> <span class="blue">self</span>

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">pais</span>(<span class="cyan">self</span>) -&gt; <span class="emerald">str</span>:
        <span class="magenta">return</span> <span class="blue">self</span>.__pais

    <span class="blue">def</span> <span class="yellow">en_codigo_postal</span>(<span class="cyan">self</span>, <span class="cyan">codigo</span>: <span class="emerald">str</span>):
        <span class="blue">self</span>.__codigo_postal = codigo
        <span class="magenta">return</span> <span class="blue">self</span>

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">codigo_postal</span>(<span class="cyan">self</span>) -&gt; <span class="emerald">str</span>:
        <span class="magenta">return</span> <span class="blue">self</span>.__codigo_postal

    <span class="blue">def</span> <span class="yellow">en_fahrenheit</span>(<span class="cyan">self</span>):
        <span class="blue">self</span>.__grados = <span class="orange">&quot;fahrenheit&quot;</span>
        <span class="magenta">return</span> <span class="blue">self</span>

    <span class="blue">def</span> <span class="yellow">en_celsius</span>(<span class="cyan">self</span>):
        <span class="blue">self</span>.__grados = <span class="orange">&quot;celsius&quot;</span>
        <span class="magenta">return</span> <span class="blue">self</span>

    <span class="blue">def</span> <span class="yellow">en_kelvin</span>(<span class="cyan">self</span>):
        <span class="blue">self</span>.__grados = <span class="orange">&quot;kelvin&quot;</span>
        <span class="magenta">return</span> <span class="blue">self</span>

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">grados</span>(<span class="cyan">self</span>) -&gt; <span class="emerald">str</span>:
        <span class="magenta">return</span> <span class="blue">self</span>.__grados

    <span class="blue">def</span> <span class="yellow">en_idioma</span>(<span class="cyan">self</span>, <span class="cyan">idioma</span>: <span class="emerald">str</span>):
        <span class="blue">self</span>.__idioma = idioma
        <span class="magenta">return</span> <span class="blue">self</span>

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">idioma</span>(<span class="cyan">self</span>) -&gt; <span class="emerald">str</span>:
        <span class="magenta">return</span> <span class="blue">self</span>.__idioma

    <span class="blue">def</span> <span class="yellow">con_id</span>(<span class="cyan">self</span>, <span class="cyan">id</span>: <span class="emerald">int</span>):
        <span class="blue">self</span>.__id = id
        <span class="magenta">return</span> <span class="blue">self</span>

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">id</span>(<span class="magenta">self</span>) -&gt; <span class="emerald">int</span>:
        <span class="magenta">return</span> <span class="blue">self</span>.__id

    <span class="blue">def</span> <span class="yellow">en_coordenadas</span>(<span class="cyan">self</span>, <span class="cyan">latitud</span>: <span class="emerald">float</span>, <span class="cyan">longitud</span>: <span class="emerald">float</span>):
        <span class="blue">self</span>.__coordenadas = (latitud, longitud)
        <span class="magenta">return</span> <span class="blue">self</span>

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">coordenadas</span>(<span class="cyan">self</span>) -&gt; (<span class="emerald">float</span>, <span class="emerald">float</span>):
        <span class="magenta">return</span> <span class="blue">self</span>.__coordenadas

    <span class="blue">def</span> <span class="yellow">_crear_clima</span>(<span class="cyan">self</span>, <span class="cyan">apikey</span>: <span class="emerald">str</span>, <span class="cyan">ciudad</span>: <span class="emerald">str</span>) -&gt; Clima:
        <span class="magenta">return</span> Clima(apikey, ciudad)

    <span class="blue">def</span> <span class="yellow">build</span>(<span class="cyan">self</span>):
        <span class="magenta">return</span> <span class="blue">self</span>._crear_clima(<span class="blue">self</span>.__apikey, <span class="blue">self</span>.__ciudad)
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py 
.................................
----------------------------------------------------------------------
Ran 33 tests in 0.000s

OK
</pre>

        <p>Además la verificación debe ser actualizada para verificar que se creó la clase con todos los argumentos y no sólo con la <em>API key</em> y la ciudad como era originalmente. Para ello hay que agregar el siguiente método:</p>

        <div class="source-code-header">climabuilder_test.py</div>
        <pre class="source-code partial-listing">
    <span class="yellow">@data</span>((<span class="orange">&quot;123abc&quot;</span>, <span class="orange">&quot;Sydney&quot;</span>, <span class="orange">&quot;au&quot;</span>, <span class="gold">1334</span>, <span class="orange">&quot;SY1233&quot;</span>, (<span class="gold">-1</span>, <span class="gold">9</span>), <span class="orange">&quot;australian english&quot;</span>, <span class="orange">&quot;fahrenheit&quot;</span>))
    <span class="yellow">@unpack</span>
    <span class="blue">def</span> <span class="yellow">test_build_con_valores_deberia_crearlo_con_ellos</span>(<span class="cyan">self</span>, <span class="cyan">apikey</span>: <span class="emerald">str</span>, <span class="cyan">ciudad</span>: <span class="emerald">str</span>, <span class="cyan">pais</span>: <span class="emerald">str</span>, <span class="cyan">id</span>: <span class="emerald">str</span>, <span class="cyan">cp</span>: <span class="emerald">str</span>, <span class="cyan">coordenadas</span>: (<span class="emerald">float</span>, <span class="emerald">float</span>), <span class="cyan">idioma</span>: <span class="emerald">str</span>, <span class="cyan">grados</span>: <span class="emerald">str</span>):
        <span class="green"># Arrange</span>
        latitud, longitud = coordenadas

        <span class="magenta">with</span> patch.object(ClimaBuilder, <span class="orange">&quot;_crear_clima&quot;</span>, <span class="cyan">return_value</span>=<span class="blue">None</span>) <span class="magenta">as</span> mock_method:
            builder = (
                ClimaBuilder().con_apikey(apikey)
                              .con_ciudad(ciudad)
                              .en_pais(pais)
                              .con_id(id)
                              .en_codigo_postal(cp)
                              .en_coordenadas(latitud, longitud)
                              .en_idioma(idioma)
            )

            <span class="magenta">if</span> grados == <span class="orange">&quot;fahrenheit&quot;</span>:
                builder.en_fahrenheit()
            <span class="magenta">elif</span> grados == <span class="orange">&quot;celsius&quot;</span>:
                builder.en_celsius()
            <span class="magenta">else</span>:
                builder.en_kelvin()

            <span class="green"># Act</span>
            clima = builder.build()

            <span class="green"># Assert</span>
            <span class="blue">self</span>.assertIsNone(clima)
            mock_method.assert_called_once_with(apikey, id, ciudad, pais, cp, (latitud, longitud), idioma, grados)
</pre>

        <p>En Python se puede usar paréntesis en la asignación de <em>builder</em> para poder alinear los métodos de <em>ClimaBuilder</em> uno debajo del otro. También se podría escribir todo en una línea pero normalmente es inconveniente tener que mover el cursor más allá del final de la pantalla para ver todos los métodos que se están llamando.</p>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 climabuilder_test.py
.F................................
======================================================================
FAIL: test_build_con_valores_deberia_crearlo_con_ellos_1___123abc____Sydney____au___1334___SY1233_____1__9____australian_english____fahrenheit__ (__main__.ClimaBuilderUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/usuario/src/python/unit-testing/lib/python3.7/site-packages/ddt.py&quot;, line 145, in wrapper
    return func(self, *args, **kwargs)
  File &quot;climabuilder_test.py&quot;, line 152, in test_build_con_valores_deberia_crearlo_con_ellos
    mock_method.assert_called_once_with(apikey, id, ciudad, pais, cp, (latitud, longitud), idioma, grados)
  File &quot;/usr/lib/python3.7/unittest/mock.py&quot;, line 884, in assert_called_once_with
    return self.assert_called_with(*args, **kwargs)
  File &quot;/usr/lib/python3.7/unittest/mock.py&quot;, line 873, in assert_called_with
    raise AssertionError(_error_message()) from cause
AssertionError: Expected call: _crear_clima('123abc', 1334, 'Sydney', 'au', 'SY1233', (-1, 9), 'australian english', 'fahrenheit')
Actual call: _crear_clima('123abc', 'Sydney')

----------------------------------------------------------------------
Ran 34 tests in 0.001s

FAILED (failures=1)
</pre>

        <p>El error indica que se esperaba que la instancia de <em>Clima</em> se creara con nueve parámetros pero que solamente se crea con dos, la <em>API key</em> y la ciudad. Para solucionarlo habría que modificar la instancia del constructor de <em>Clima</em> para que reciba todos esos argumentos, sin embargo algunos de ellos son incompatibles: la ciudad se puede indicar por id, coordenadas, nombre de ciudad (más país), o código postal (más país).</p>

        <p>Existen dos formas simples de solucionar este problema: la primera es hacerlos mutuamente exclusivos (si se indica el nombre de una ciudad se deberían borrar las coordenadas, el id y el código postal, por ejemplo), la segunda es permitir que el usuario ingrese cualquier dato (incluyendo los mutuamente exclusivos) y que luego la clase <em>Clima</em> determine el orden de prioridades, por ejemplo buscar primero la ciudad, después el código postal, etc.</p>
 
        <p>El primer paso es modificar en <em>ClimaBuilder</em> tanto <em>_crear_clima</em> como <em>build</em> para que pasen al constructor de <em>Clima</em> todos los argumentos en el orden correcto.</p>

        <div class="source-code-header">climabuilder.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">_crear_clima</span>(<span class="cyan">self</span>, <span class="cyan">apikey</span>: <span class="emerald">str</span>, <span class="cyan">id</span>: <span class="emerald">int</span>, <span class="cyan">ciudad</span>: <span class="emerald">str</span>, <span class="cyan">pais</span>: <span class="emerald">str</span>, <span class="cyan">cp</span>: <span class="emerald">str</span>, <span class="cyan">coordenadas</span>: (<span class="emerald">float</span>, <span class="emerald">float</span>), <span class="cyan">idioma</span>: <span class="emerald">str</span>, <span class="cyan">grados</span>: <span class="emerald">str</span>) -&gt; Clima:
        <span class="magenta">return</span> Clima(apikey, id, ciudad, pais, cp, coordenadas, idioma, grados)

    <span class="blue">def</span> <span class="yellow">build</span>(<span class="cyan">self</span>):
        <span class="magenta">return</span> <span class="blue">self</span>._crear_clima(<span class="blue">self</span>.__apikey, <span class="blue">self</span>.__id, <span class="blue">self</span>.__ciudad, <span class="blue">self</span>.__pais, <span class="blue">self</span>.__codigo_postal, <span class="blue">self</span>.__coordenadas, <span class="blue">self</span>.__idioma, <span class="blue">self</span>.__grados)
</pre>
       
        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 climabuilder_test.py
..................................
----------------------------------------------------------------------
Ran 34 tests in 0.001s

OK
</pre>

        <p>Queda por modificar el constructor de la clase <em>Clima</em> para que reciba todos los argumentos correctamente. Como se van a agregar varios atributos a dicha clase lo que corresponde es primero agregar en <em>clima_test.py</em> las pruebas unitarias para verificar que al construir un objeto con un valor determinado se guarde correctamente el valor. Utilizando <em>ddt</em>:</p>

        <div class="source-code-header">clima_test.py</div>
        <pre class="source-code full-listing">
<span class="magenta">import</span> unittest
<span class="magenta">from</span> ddt <span class="magenta">import</span> ddt, data
<span class="magenta">from</span> climabuilder <span class="magenta">import</span> ClimaBuilder
<span class="magenta">from</span> clima <span class="magenta">import</span> Clima

<span class="yellow">@ddt</span>
<span class="blue">class</span> <span class="emerald">ClimaUnitTests</span>(<span class="emerald">unittest</span>.<span class="emerald">TestCase</span>):
    <span class="blue">def</span> <span class="yellow">test_constructor_con_una_apikey_valida_deberia_incorporarla</span>(<span class="cyan">self</span>):
        apikey = <span class="orange">&quot;abcdefg&quot;</span>

        sut = ClimaBuilder().con_apikey(apikey).build()

        <span class="blue">self</span>.assertEqual(apikey, sut.apikey)

    <span class="blue">def</span> <span class="yellow">test_constructor_con_una_apikey_vacia_deberia_lanzar_valueerror</span>(<span class="cyan">self</span>):
        <span class="magenta">with</span> <span class="blue">self</span>.assertRaises(<span class="emerald">ValueError</span>) <span class="magenta">as</span> ve:
            sut = ClimaBuilder().con_apikey(<span class="orange">&quot;&quot;</span>).build()

    <span class="blue">def</span> <span class="yellow">test_constructor_con_una_apikey_en_blanco_deberia_lanzar_valueerror</span>(<span class="cyan">self</span>):
        <span class="magenta">with</span> <span class="blue">self</span>.assertRaises(<span class="emerald">ValueError</span>) <span class="magenta">as</span> ve:
            sut = ClimaBuilder().con_apikey(<span class="orange">&quot;&nbsp;&nbsp;&nbsp;&nbsp;&quot;</span>).build()

    <span class="blue">def</span> <span class="yellow">test_constructor_con_none_deberia_lanzar_valueerror</span>(<span class="cyan">self</span>):
        <span class="magenta">with</span> <span class="blue">self</span>.assertRaises(<span class="emerald">ValueError</span>) <span class="magenta">as</span> ve:
            sut = ClimaBuilder().con_apikey(<span class="blue">None</span>).build()

    <span class="blue">def</span> <span class="yellow">test_constructor_con_ciudad_valida_deberia_incorporarla</span>(<span class="cyan">self</span>):
        ciudad = <span class="orange">&quot;London&quot;</span>
        apikey = <span class="orange">&quot;abcdefg&quot;</span>

        sut = ClimaBuilder().con_apikey(apikey).con_ciudad(ciudad).build()
        <span class="blue">self</span>.assertEqual(ciudad, sut.ciudad)

    <span class="yellow">@data</span>(<span class="blue">None</span>, <span class="gold">-11</span>, <span class="gold">0</span>, <span class="gold">10</span>, <span class="gold">2172797</span>)
    <span class="blue">def</span> <span class="yellow">test_constructor_con_cualquier_id_deberia_incorporarlo</span>(<span class="cyan">self</span>, <span class="cyan">cualquier_id</span>: <span class="emerald">int</span>):
        <span class="green"># Arrange</span>
        cualquier_id = id

        <span class="green"># Act</span>
        sut = ClimaBuilder().con_apikey(<span class="orange">&quot;abcdefg&quot;</span>).con_id(cualquier_id).build()

        <span class="green"># Assert</span>
        self.assertEqual(cualquier_id, sut.id)

    <span class="yellow">@data</span>(<span class="blue">None</span>, <span class="orange">&quot;&quot;</span>, <span class="orange">&quot;ar&quot;</span>, <span class="orange">&quot;uy&quot;</span>)
    <span class="blue">def</span> <span class="yellow">test_constructor_con_cualquier_pais_deberia_incorporarlo</span>(<span class="cyan">self</span>, <span class="cyan">cualquier_pais</span>: <span class="emerald">str</span>):
        <span class="green"># Act</span>
        sut = ClimaBuilder().con_apikey(<span class="orange">&quot;abcdefg&quot;</span>).en_pais(cualquier_pais).build()

        <span class="green"># Assert</span>
        self.assertEqual(cualquier_pais, sut.pais)

    <span class="yellow">@data</span>(<span class="blue">None</span>, <span class="orange">&quot;&quot;</span>, <span class="orange">&quot;13233&quot;</span>)
    <span class="blue">def</span> <span class="yellow">test_constructor_con_cualquier_codigo_postal_deberia_incorporarlo</span>(<span class="cyan">self</span>, <span class="cyan">cualquier_cp</span>: <span class="emerald">str</span>):
        <span class="green"># Act</span>
        sut = ClimaBuilder().con_apikey(<span class="orange">&quot;abcdefg&quot;</span>).en_codigo_postal(cualquier_cp).build()

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(cualquier_cp, sut.codigo_postal)

    <span class="blue">def</span> <span class="yellow">test_constructor_con_cualquier_coordenadas_deberia_incorporarlo</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        latitud, longitud = (<span class="gold">34.6037</span>, <span class="gold">58.3816</span>)

        <span class="green"># Act</span>
        sut = ClimaBuilder().con_apikey(<span class="orange">&quot;abcdefg&quot;</span>).en_coordenadas(latitud, longitud).build()

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual((latitud, longitud), sut.coordenadas)

    <span class="yellow">@data</span>(<span class="blue">None</span>, <span class="orange">&quot;&quot;</span>, <span class="orange">&quot;sp&quot;</span>)
    <span class="blue">def</span> <span class="yellow">test_constructor_con_cualquier_idioma_deberia_incorporarlo</span>(<span class="cyan">self</span>, <span class="cyan">cualquier_idioma</span>: <span class="emerald">str</span>):
        <span class="green"># Act</span>
        sut = ClimaBuilder().con_apikey(<span class="orange">&quot;abcdefg&quot;</span>).en_idioma(cualquier_idioma).build()

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(cualquier_idioma, sut.idioma)

    <span class="blue">def</span> <span class="yellow">test_constructor_con_fahrenheit_deberia_incorporarlo</span>(<span class="cyan">self</span>):
        <span class="green"># Act</span>
        sut = ClimaBuilder().con_apikey(<span class="orange">&quot;abcdefg&quot;</span>).en_fahrenheit().build()

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(<span class="orange">&quot;fahrenheit&quot;</span>, sut.grados)

    <span class="blue">def</span> <span class="yellow">test_constructor_con_celsius_deberia_incorporarlo</span>(<span class="cyan">self</span>):
        <span class="green"># Act</span>
        sut = ClimaBuilder().con_apikey(<span class="orange">&quot;abcdefg&quot;</span>).en_celsius().build()

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(<span class="orange">&quot;celsius&quot;</span>, sut.grados)

    <span class="blue">def</span> <span class="yellow">test_constructor_con_kelvin_deberia_incorporarlo</span>(<span class="cyan">self</span>):
        <span class="green"># Act</span>
        sut = ClimaBuilder().con_apikey(<span class="orange">&quot;abcdefg&quot;</span>).en_kelvin().build()

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(<span class="orange">&quot;kelvin&quot;</span>, sut.grados)

<span class="magenta">if</span> <span class="cyan">__name__</span> == <span class="orange">&quot;__main__&quot;</span>:
    unittest.main()
</pre>

        <p>Y luego se modifica la clase <em>Clima</em> para aceptar todos los argumentos en el constructor, además de agregar las propiedades de lectura:</p>

        <div class="source-code-header">clima.py</div>
        <pre class="source-code full-listing">
<span class="blue">class</span> <span class="emerald">Clima</span>:
    <span class="blue">def</span> <span class="yellow">__init__</span>(<span class="cyan">self</span>, <span class="cyan">apikey</span>: <span class="emerald">str</span>, <span class="cyan">id</span>: <span class="emerald">int</span>, <span class="cyan">ciudad</span>: <span class="emerald">str</span>, <span class="cyan">pais</span>: <span class="emerald">str</span>, <span class="cyan">cp</span>: <span class="emerald">str</span>, <span class="cyan">coordenadas</span>: (<span class="emerald">float</span>, <span class="emerald">float</span>), <span class="cyan">idioma</span>: <span class="emerald">str</span>, <span class="cyan">grados</span>: <span class="emerald">str</span>):
        <span class="blue">self</span>.__apikey = apikey.strip() <span class="magenta">if</span> apikey <span class="blue">is not None</span> <span class="magenta">else</span> <span class="orange">&quot;&quot;</span>
        <span class="magenta">if</span> <span class="blue">self</span>.__apikey == <span class="orange">&quot;&quot;</span>:
            <span class="magenta">raise</span> <span class="emerald">ValueError</span>()

        <span class="blue">self</span>.__id = id
        <span class="blue">self</span>.__ciudad = ciudad
        <span class="blue">self</span>.__pais = pais
        <span class="blue">self</span>.__codigo_postal = cp
        <span class="blue">self</span>.__coordenadas = coordenadas
        <span class="blue">self</span>.__idioma = idioma
        <span class="blue">self</span>.__grados = grados

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">apikey</span>(<span class="cyan">self</span>) -&gt; <span class="emerald">str</span>:
        <span class="magenta">return</span> <span class="blue">self</span>.__apikey

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">ciudad</span>(<span class="cyan">self</span>) -&gt; <span class="emerald">str</span>:
        <span class="magenta">return</span> <span class="blue">self</span>.__ciudad

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">id</span>(<span class="cyan">self</span>) -&gt; <span class="emerald">int</span>:
        <span class="magenta">return</span> <span class="blue">self</span>.__id

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">pais</span>(<span class="cyan">self</span>) -&gt; <span class="emerald">str</span>:
        <span class="magenta">return</span> <span class="blue">self</span>.__pais

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">codigo_postal</span>(<span class="cyan">self</span>) -&gt; <span class="emerald">str</span>:
        <span class="magenta">return</span> <span class="blue">self</span>.__codigo_postal

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">coordenadas</span>(<span class="cyan">self</span>) -&gt; (<span class="emerald">float</span>, <span class="emerald">float</span>):
        <span class="magenta">return</span> <span class="blue">self</span>.__coordenadas

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">idioma</span>(<span class="cyan">self</span>) -&gt; <span class="emerald">str</span>:
        <span class="magenta">return</span> <span class="blue">self</span>.__idioma

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">grados</span>(<span class="cyan">self</span>) -&gt; <span class="emerald">str</span>:
        <span class="magenta">return</span> <span class="blue">self</span>.__grados
</pre>


        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 climabuilder_test.py 
.....................................
----------------------------------------------------------------------
Ran 34 tests in 0.001s

OK
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py 
........................
----------------------------------------------------------------------
Ran 24 tests in 0.001s

OK
</pre>

        <p>En este momento es recomendable modificar a <em class="breakable-word">test_build_con_valores_deberia_crearlo_con_ellos</em> en <em>climabuilder_test.py</em> para que sea alimentado por una cantidad de datos suficiente como para verificar cada una de las combinaciones válidas posibles:</p>

        <div class="source-code-header">climabuilder_test.py</div>
        <pre class="source-code partial-listing">
    <span class="yellow">@data</span>(
        ( <span class="gold">2172797</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="orange">&quot;english&quot;</span>, <span class="orange">&quot;fahrenheit&quot;</span> ),
        ( <span class="blue">None</span>, <span class="orange">&quot;Sydney&quot;</span>, <span class="orange">&quot;au&quot;</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="orange">&quot;australian english&quot;</span>, <span class="orange">&quot;kelvin&quot;</span> ),
        ( <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="gold">34.6037</span>, <span class="gold">58.3816</span>, <span class="orange">&quot;sp&quot;</span>, <span class="orange">&quot;celsius&quot;</span> ),
        ( <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="orange">&quot;92730&quot;</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="orange">&quot;en&quot;</span>, <span class="orange">&quot;fahrenheit&quot;</span> )
    )
    <span class="yellow">@unpack</span>
    <span class="blue">def</span> <span class="yellow">test_build_con_varios_valores_deberia_crearlo_con_ellos</span>(<span class="cyan">self</span>, <span class="cyan">id</span>: <span class="emerald">int</span>, <span class="cyan">ciudad</span>: <span class="emerald">str</span>, <span class="cyan">pais</span>: <span class="emerald">str</span>, <span class="cyan">cp</span>: <span class="emerald">str</span>, <span class="cyan">latitud</span>: <span class="emerald">float</span>, <span class="cyan">longitud</span>: <span class="emerald">float</span>, <span class="cyan">idioma</span>: <span class="emerald">str</span>, <span class="cyan">grados</span>: <span class="emerald">str</span>):
        <span class="green"># Arrange</span>
        apikey = <span class="orange">&quot;abcdefg&quot;</span>

        <span class="magenta">with</span> patch.object(ClimaBuilder, <span class="orange">&quot;_crear_clima&quot;</span>, <span class="cyan">return_value</span>=<span class="blue">None</span>) <span class="magenta">as</span> mock_method:
            builder = (
                ClimaBuilder().con_apikey(apikey)
                              .con_id(id)
                              .con_ciudad(ciudad)
                              .en_pais(pais)
                              .en_codigo_postal(cp)
                              .en_coordenadas(latitud, longitud)
                              .en_idioma(idioma)
            )

            <span class="magenta">if</span> grados == <span class="orange">&quot;fahrenheit&quot;</span>:
                builder.en_fahrenheit()
            <span class="magenta">elif</span> grados == <span class="orange">&quot;celsius&quot;</span>:
                builder.en_celsius()
            <span class="magenta">else</span>:
                builder.en_kelvin()

            <span class="green"># Act</span>
            clima = builder.build()

            <span class="green"># Assert</span>
            <span class="blue">self</span>.assertIsNone(clima)
            mock_method.assert_called_once_with(apikey, id, ciudad, pais, cp, (latitud, longitud), idioma, grados)
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 climabuilder_test.py
.....................................
----------------------------------------------------------------------
Ran 37 tests in 0.002s

OK
</pre>

        <p>A simple vista las pruebas unitarias de <em>Clima</em> son similares, verifican que el estado interno de ambas clases se mantenga correctamente después de setearlo. Es común que clases compartan atributos y por consiguiente que existan pruebas unitarias que se parezcan entre ellas.</p>

        <h2 id="preparacionapi">Preparación de la API</h2>

        <p>Para acceder a la API de <em>OpenWeather</em> se utilizan mensajes <em>GET</em> que se envían a través de una <em>url</em>. Al tener todos los valores necesarios para construir dicha <em>url</em> al instanciar <em>Clima</em> es posible calcular la dirección a la que se debe conectar. Una vez calculada puede exponerse a través de una propiedad de sólo lectura como al resto de las propiedades.</p>
        <p>Para comenzar se importa en <em>clima_test.py</em> la funcionalidad de <em>unpack</em>:</p>

        <div class="source-code-header">clima_test.py</div>
        <pre class="source-code partial-listing">
<span class="magenta">from</span> ddt <span class="magenta">import</span> ddt, data, unpack
</pre>

        <p>y luego se agrega la nueva prueba:</p>

        <div class="source-code-header">clima_test.py</div>
        <pre class="source-code partial-listing">
    <span class="yellow">@data</span>(
        ( <span class="gold">2172797</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, (<span class="blue">None</span>, <span class="blue">None</span>), <span class="orange">&quot;&quot;,</span> <span class="orange">&quot;fahrenheit&quot;</span>, <span class="orange">&quot;http://api.openweathermap.org/data/2.5/weather?appid=abcdefg&amp;id=2172797&amp;units=imperial&quot;</span> ),
        ( <span class="blue">None</span>, <span class="orange">&quot;Sydney&quot;</span>, <span class="orange">&quot;au&quot;</span>, <span class="blue">None</span>, (<span class="blue">None</span>, <span class="blue">None</span>), <span class="orange">&quot;fr&quot;</span>, <span class="orange">&quot;kelvin&quot;</span>, <span class="orange">&quot;http://api.openweathermap.org/data/2.5/weather?appid=abcdefg&amp;q=Sydney,au&amp;lang=fr&quot;</span> ),
        ( <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, (<span class="gold">34.6037</span>, <span class="gold">58.3816</span>), <span class="orange">&quot;es&quot;</span>, <span class="orange">&quot;celsius&quot;</span>, <span class="orange">&quot;http://api.openweathermap.org/data/2.5/weather?appid=abcdefg&amp;lat=34.6037&amp;lon=58.3816&amp;lang=es&amp;units=metric&quot;</span> ),
        ( <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="orange">&quot;94040&quot;</span>, (<span class="blue">None</span>, <span class="blue">None</span>), <span class="orange">&quot;ja&quot;</span>, <span class="orange">&quot;fahrenheit&quot;</span>, <span class="orange">&quot;http://api.openweathermap.org/data/2.5/weather?appid=abcdefg&amp;zip=94040&amp;lang=ja&amp;units=imperial&quot;</span> ),
        ( <span class="blue">None</span>, <span class="blue">None</span>, <span class="orange">&quot;ar&quot;</span>, <span class="orange">&quot;94040&quot;</span>, (<span class="blue">None</span>, <span class="blue">None</span>), <span class="orange">&quot;ja&quot;</span>, <span class="orange">&quot;fahrenheit&quot;</span>, <span class="orange">&quot;http://api.openweathermap.org/data/2.5/weather?appid=abcdefg&amp;zip=94040,ar&amp;lang=ja&amp;units=imperial&quot;</span> )
    )
    <span class="yellow">@unpack</span>
    <span class="blue">def</span> <span class="yellow">test_url_con_datos_deberia_crear_url</span>(<span class="cyan">self</span>, <span class="cyan">id</span>: <span class="emerald">int</span>, <span class="cyan">ciudad</span>: <span class="emerald">str</span>, <span class="cyan">pais</span>: <span class="emerald">str</span>, <span class="cyan">cp</span>: <span class="emerald">str</span>, <span class="cyan">coordenadas</span>: (<span class="emerald">float</span>, <span class="emerald">float</span>), <span class="cyan">idioma</span>: <span class="emerald">str</span>, <span class="cyan">grados</span>: <span class="emerald">str</span>, <span class="cyan">url</span>: <span class="emerald">str</span>):
        <span class="green"># Arrange</span>
        apikey = <span class="orange">&quot;abcdefg&quot;</span>

        <span class="green"># Act</span>
        clima = Clima(apikey, id, ciudad, pais, cp, coordenadas, idioma, grados)

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(url, clima.url)
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py
........................EEEEE
======================================================================
ERROR: test_url_con_datos_deberia_crear_url_1__2172797__None__None__None___None__None________fahrenheit____http___api_openweathermap_org_data_2_5_weather_appid_abcdefg_id_2172797_units_imperial__ (__main__.ClimaUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/usuario/src/python/unit-testing/lib/python3.7/site-packages/ddt.py&quot;, line 145, in wrapper
    return func(self, *args, **kwargs)
  File &quot;clima_test.py&quot;, line 116, in test_url_con_datos_deberia_crear_url
    self.assertEqual(url, clima.url)
AttributeError: 'Clima' object has no attribute 'url'

======================================================================
ERROR: test_url_con_datos_deberia_crear_url_2__None___Sydney____au___None___None__None____fr____kelvin____http___api_openweathermap_org_data_2_5_weather_appid_abcdefg_q_Sydney_au_lang_fr__ (__main__.ClimaUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/usuario/src/python/unit-testing/lib/python3.7/site-packages/ddt.py&quot;, line 145, in wrapper
    return func(self, *args, **kwargs)
  File &quot;clima_test.py&quot;, line 116, in test_url_con_datos_deberia_crear_url
    self.assertEqual(url, clima.url)
AttributeError: 'Clima' object has no attribute 'url'

======================================================================
ERROR: test_url_con_datos_deberia_crear_url_3__None__None__None__None___34_6037__58_3816____es____celsius____http___api_openweathermap_org_data_2_5_weather_appid_abcdefg_lat_34_6037_lon_58_3816_lang_es_units_metric__ (__main__.ClimaUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/usuario/src/python/unit-testing/lib/python3.7/site-packages/ddt.py&quot;, line 145, in wrapper
    return func(self, *args, **kwargs)
  File &quot;clima_test.py&quot;, line 116, in test_url_con_datos_deberia_crear_url
    self.assertEqual(url, clima.url)
AttributeError: 'Clima' object has no attribute 'url'

======================================================================
ERROR: test_url_con_datos_deberia_crear_url_4__None__None__None___94040____None__None____ja____fahrenheit____http___api_openweathermap_org_data_2_5_weather_appid_abcdefg_zip_94040_lang_ja_units_imperial__ (__main__.ClimaUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/usuario/src/python/unit-testing/lib/python3.7/site-packages/ddt.py&quot;, line 145, in wrapper
    return func(self, *args, **kwargs)
  File &quot;clima_test.py&quot;, line 116, in test_url_con_datos_deberia_crear_url
    self.assertEqual(url, clima.url)
AttributeError: 'Clima' object has no attribute 'url'

======================================================================
ERROR: test_url_con_datos_deberia_crear_url_5__None__None___ar____94040____None__None____ja____fahrenheit____http___api_openweathermap_org_data_2_5_weather_appid_abcdefg_zip_94040_ar_lang_ja_units_imperial__ (__main__.ClimaUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/usuario/src/python/unit-testing/lib/python3.7/site-packages/ddt.py&quot;, line 145, in wrapper
    return func(self, *args, **kwargs)
  File &quot;clima_test.py&quot;, line 116, in test_url_con_datos_deberia_crear_url
    self.assertEqual(url, clima.url)
AttributeError: 'Clima' object has no attribute 'url'

----------------------------------------------------------------------
Ran 29 tests in 0.001s

FAILED (errors=5)
</pre>

        <p>El siguiente paso es agregar el código dentro del constructor de <em>Clima</em> para generar la <em>url</em> y crear la propiedad con la cual se podrá consultar su valor:</p>

        <div class="source-code-header">clima.py</div>
        <pre class="source-code partial-listing">
<span class="blue">class</span> <span class="emerald">Clima</span>:
    <span class="blue">def</span> <span class="yellow">__init__</span>(<span class="cyan">self</span>, <span class="cyan">apikey</span>: <span class="emerald">str</span>, <span class="cyan">id</span>: <span class="emerald">int</span>, <span class="cyan">ciudad</span>: <span class="emerald">str</span>, <span class="cyan">pais</span>: <span class="emerald">str</span>, <span class="cyan">cp</span>: <span class="emerald">str</span>, <span class="cyan">coordenadas</span>: (<span class="emerald">float</span>, <span class="emerald">float</span>), <span class="cyan">idioma</span>: <span class="emerald">str</span>, <span class="cyan">grados</span>: <span class="emerald">str</span>):
        <span class="blue">self</span>.__apikey = apikey.strip() <span class="magenta">if</span> apikey <span class="blue">is not None</span> <span class="magenta">else</span> <span class="orange">&quot;&quot;</span>
        <span class="magenta">if</span> self.__apikey == <span class="orange">&quot;&quot;</span>:
            <span class="magenta">raise</span> <span class="emerald">ValueError</span>()

        <span class="blue">self</span>.__id = id
        <span class="blue">self</span>.__ciudad = ciudad
        <span class="blue">self</span>.__pais = pais
        <span class="blue">self</span>.__codigo_postal = cp
        <span class="blue">self</span>.__coordenadas = coordenadas
        <span class="blue">self</span>.__idioma = idioma
        <span class="blue">self</span>.__grados = grados
        <span class="blue">self</span>.__url = <span class="blue">self</span>._build_url()

    <span class="blue">def</span> <span class="yellow">_build_url</span>(<span class="cyan">self</span>):
        url = <span class="orange">f&quot;http://api.openweathermap.org/data/2.5/weather?appid={self.__apikey}&quot;</span>
        <span class="magenta">if</span> <span class="blue">self</span>.__id <span class="blue">is not None</span>:
            url = <span class="orange">f&quot;{url}&amp;id={self.__id}&quot;</span>
        <span class="magenta">elif</span> <span class="blue">self</span>.__ciudad <span class="blue">is not None</span>:
            url = <span class="orange">f&quot;{url}&amp;q={self.__ciudad}&quot;</span>

            <span class="magenta">if</span> <span class="blue">self</span>.__pais <span class="blue">is not None</span>:
                url = <span class="orange">f&quot;{url},{self.__pais}&quot;</span>
        <span class="magenta">elif</span> <span class="blue">self</span>.__codigo_postal <span class="blue">is not None</span>:
            url = <span class="orange">f&quot;{url}&amp;zip={self.__codigo_postal}&quot;</span>

            <span class="magenta">if</span> <span class="blue">self</span>.__pais <span class="blue">is not None</span>:
                url = <span class="orange">f&quot;{url},{self.__pais}&quot;</span>
        <span class="magenta">elif</span> <span class="blue">self</span>.__coordenadas <span class="blue">is not None</span>:
            url = <span class="orange">f&quot;{url}&amp;lat={self.__coordenadas[0]}&amp;lon={self.__coordenadas[1]}&quot;</span>

        <span class="magenta">if</span> <span class="blue">self</span>.__idioma <span class="blue">is not None and self</span>.__idioma != <span class="orange">&quot;&quot;</span> <span class="blue">and self</span>.__idioma != <span class="orange">&quot;en&quot;</span>:
            url = <span class="orange">f&quot;{url}&amp;lang={self.__idioma}&quot;</span>

        <span class="magenta">if</span> <span class="blue">self</span>.__grados <span class="blue">is not None</span>:
            <span class="magenta">if</span> <span class="blue">self</span>.__grados == <span class="orange">&quot;fahrenheit&quot;</span>:
                url = <span class="orange">f&quot;{url}&amp;units=imperial&quot;</span>
            <span class="magenta">elif</span> <span class="blue">self</span>.__grados == <span class="orange">&quot;celsius&quot;</span>:
                url = <span class="orange">f&quot;{url}&amp;units=metric&quot;</span>

        <span class="magenta">return</span> url

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">url</span>(<span class="cyan">self</span>) -&gt; <span class="emerald">str</span>:
        <span class="magenta">return</span> <span class="blue">self</span>.__url
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py
.............................
----------------------------------------------------------------------
Ran 29 tests in 0.001s

OK
</pre>
        <p>Se sobreentiende que para llegar a esta versión de <em>_build_url</em> se requirieron varios ciclos de prueba fallida e implementación de código (al menos una iteración por cada juego de datos para crear las diferentes combinaciones de <em>urls</em>). Por una cuestión de brevedad nuevamente se ha simplificado el proceso mostrando la versión final.</p>

        <p>Existen dos problemas inmediatos: si tanto la ciudad como el código postal, las coordenadas y el id son nulos, no es posible calcular la temperatura por lo que en ese caso se debe lanzar una excepción. Por otro lado, las coordenadas no pueden tener un elemento (latitud o longitud) nulo, en cuyo caso también es necesario lanzar una excepción. Se agregan dos pruebas que cubran ambos escenarios.</p>

        <div class="source-code-header">clima_test.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">test_constructor_con_ciudad_codigo_postal_coordenadas_id_nulas_deberia_lanzar_valueerror</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        apikey = <span class="orange">&quot;abcdefg&quot;</span>

        <span class="green"># Act / Assert</span>
        <span class="magenta">with</span> <span class="blue">self</span>.assertRaises(<span class="emerald">ValueError</span>) <span class="magenta">as</span> ve:
            sut = Clima(apikey, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>)

    <span class="blue">def</span> <span class="yellow">test_constructor_con_latitud_o_longitud_nulas_y_ninguna_otra_locacion_deberia_lanzar_valueerror</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        apikey = <span class="orange">&quot;abcdefg&quot;</span>
        url_servicio = <span class="orange">&quot;http://api.openweathermap.org/data/2.5/weather&quot;</span>

        <span class="green"># Act / Assert</span>
        <span class="magenta">with</span> self.assertRaises(<span class="emerald">ValueError</span>) <span class="magenta">as</span> ve:
            sut = Clima(apikey, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, (<span class="blue">None</span>, <span class="blue">None</span>), <span class="blue">None</span>, <span class="blue">None</span>)
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py
.F...................F.........
======================================================================
FAIL: test_constructor_con_ciudad_codigo_postal_coordenadas_id_nulas_deberia_lanzar_valueerror (__main__.ClimaUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;clima_test.py&quot;, line 124, in test_constructor_con_ciudad_codigo_postal_coordenadas_id_nulas_deberia_lanzar_valueerror
    sut = Clima(apikey, None, None, None, None, None, None, None)
AssertionError: ValueError not raised

======================================================================
FAIL: test_constructor_con_latitud_o_longitud_nulas_y_ninguna_otra_locacion_deberia_lanzar_valueerror (__main__.ClimaUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;clima_test.py&quot;, line 134, in test_constructor_con_latitud_o_longitud_nulas_y_ninguna_otra_locacion_deberia_lanzar_valueerror
    sut = Clima(apikey, None, None, None, None, (None, None), None, None)
AssertionError: ValueError not raised

----------------------------------------------------------------------
Ran 31 tests in 0.001s

FAILED (failures=2)
</pre>
        <p>La implementación en la clase agrega los respectivos chequeos y excepciones:</p>

        <div class="source-code-header">clima.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">_build_url</span>(<span class="cyan">self</span>):
        url = <span class="orange">f&quot;http://api.openweathermap.org/data/2.5/weather?appid={self.__apikey}&quot;</span>
        <span class="magenta">if</span> <span class="blue">self</span>.__id <span class="blue">is not None</span>:
            url = <span class="orange">f&quot;{url}&amp;id={self.__id}&quot;</span>
        <span class="magenta">elif</span> <span class="blue">self</span>.__ciudad <span class="blue">is not None</span>:
            url = <span class="orange">f&quot;{url}&amp;q={self.__ciudad}&quot;</span>

            <span class="magenta">if</span> <span class="blue">self</span>.__pais <span class="blue">is not None</span>:
                url = <span class="orange">f&quot;{url},{self.__pais}&quot;</span>
        <span class="magenta">elif</span> <span class="blue">self</span>.__codigo_postal <span class="blue">is not None</span>:
            url = <span class="orange">f&quot;{url}&amp;zip={self.__codigo_postal}&quot;</span>

            <span class="magenta">if</span> <span class="blue">self</span>.__pais <span class="blue">is not None</span>:
                url = <span class="orange">f&quot;{url},{self.__pais}&quot;</span>
        <span class="magenta">elif</span> <span class="blue">self</span>.__coordenadas <span class="blue">is not None</span>:
            <span class="magenta">if</span> <span class="blue">None</span> <span class="magenta">in</span> <span class="blue">self</span>.__coordenadas:
                <span class="magenta">raise</span> <span class="emerald">ValueError</span>()

            url = <span class="orange">f&quot;{url}&amp;lat={self.__coordenadas[0]}&amp;lon={self.__coordenadas[1]}&quot;</span>
        <span class="magenta">else</span>:
            <span class="magenta">raise</span> <span class="emerald">ValueError</span>()

        <span class="magenta">if</span> <span class="blue">self</span>.__idioma <span class="blue">is not None and self</span>.__idioma != <span class="orange">&quot;&quot;</span> <span class="blue">and self</span>.__idioma != <span class="orange">&quot;en&quot;</span>:
            url = <span class="orange">f&quot;{url}&amp;lang={self.__idioma}&quot;</span>

        <span class="magenta">if</span> <span class="blue">self</span>.__grados <span class="blue">is not None</span>:
            <span class="magenta">if</span> <span class="blue">self</span>.__grados == <span class="orange">&quot;fahrenheit&quot;</span>:
                url = <span class="orange">f&quot;{url}&amp;units=imperial&quot;</span>
            <span class="magenta">elif</span> <span class="blue">self</span>.__grados == <span class="orange">&quot;celsius&quot;</span>:
                url = <span class="orange">f&quot;{url}&amp;units=metric&quot;</span>

        <span class="magenta">return</span> url
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py
...............................
----------------------------------------------------------------------
Ran 31 tests in 0.001s

OK
</pre>
        <p>Para permitir la conexión a distintas direcciones (por ejemplo, para el clima actual existen dos conexiones posibles, a un servidor de prueba y al servidor de producción) se implementará una propiedad que permita ingresar la <em>url</em> base del servicio a utilizar.</p>

        <p>Se agrega una prueba en <em>climabuilder_test.py</em> para verificar que dicha <em>url</em> se guarde correctamente:</p>
        
        <div class="source-code-header">climabuilder_test.py</div>
        <pre class="source-code partial-listing">
    <span class="yellow">@data</span>(<span class="blue">None</span>, <span class="orange">&quot;&quot;,</span> <span class="orange">&quot;&nbsp;&nbsp;&nbsp;&nbsp;&quot;</span>, <span class="orange">&quot;http://www.example.com&quot;</span>, <span class="orange">&quot;http://api.openweathermap.org/data/2.5/weather&quot;</span>)
    <span class="blue">def</span> <span class="yellow">test_con_servicio_con_cualquier_url_deberia_incorporarlo</span>(<span class="cyan">self</span>, <span class="cyan">cualquier_url</span>: <span class="emerald">str</span>):
        <span class="green"># Arrange</span>
        builder = ClimaBuilder()

        <span class="green"># Act</span>
        builder.con_servicio(cualquier_url)

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(cualquier_url, builder.url_servicio)
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 climabuilder_test.py
.....EEEEE................................
======================================================================
ERROR: test_builder_con_cualquier_url_deberia_incorporarlo_1_None (__main__.ClimaBuilderUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/usuario/src/python/unit-testing/lib/python3.7/site-packages/ddt.py&quot;, line 145, in wrapper
    return func(self, *args, **kwargs)
  File &quot;climabuilder_test.py&quot;, line 165, in test_con_servicio_con_cualquier_url_deberia_incorporarlo
    builder.con_servicio(cualquier_url)
AttributeError: 'ClimaBuilder' object has no attribute 'con_servicio'

======================================================================
ERROR: test_builder_con_cualquier_url_deberia_incorporarlo_2_ (__main__.ClimaBuilderUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/usuario/src/python/unit-testing/lib/python3.7/site-packages/ddt.py&quot;, line 145, in wrapper
    return func(self, *args, **kwargs)
  File &quot;climabuilder_test.py&quot;, line 165, in test_builder_con_cualquier_url_deberia_incorporarlo
    builder.con_servicio(cualquier_url)
AttributeError: 'ClimaBuilder' object has no attribute 'con_servicio'

======================================================================
ERROR: test_builder_con_cualquier_url_deberia_incorporarlo_3_____ (__main__.ClimaBuilderUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/usuario/src/python/unit-testing/lib/python3.7/site-packages/ddt.py&quot;, line 145, in wrapper
    return func(self, *args, **kwargs)
  File &quot;climabuilder_test.py&quot;, line 165, in test_builder_con_cualquier_url_deberia_incorporarlo
    builder.con_servicio(cualquier_url)
AttributeError: 'ClimaBuilder' object has no attribute 'con_servicio'

======================================================================
ERROR: test_builder_con_cualquier_url_deberia_incorporarlo_4_http___www_example_com (__main__.ClimaBuilderUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/usuario/src/python/unit-testing/lib/python3.7/site-packages/ddt.py&quot;, line 145, in wrapper
    return func(self, *args, **kwargs)
  File &quot;climabuilder_test.py&quot;, line 165, in test_builder_con_cualquier_url_deberia_incorporarlo
    builder.con_servicio(cualquier_url)
AttributeError: 'ClimaBuilder' object has no attribute 'con_servicio'

======================================================================
ERROR: test_builder_con_cualquier_url_deberia_incorporarlo_5_http___api_openweathermap_org_data_2_5_weather (__main__.ClimaBuilderUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/usuario/src/python/unit-testing/lib/python3.7/site-packages/ddt.py&quot;, line 145, in wrapper
    return func(self, *args, **kwargs)
  File &quot;climabuilder_test.py&quot;, line 165, in test_builder_con_cualquier_url_deberia_incorporarlo
    builder.con_servicio(cualquier_url)
AttributeError: 'ClimaBuilder' object has no attribute 'con_servicio'

----------------------------------------------------------------------
Ran 42 tests in 0.002s

FAILED (errors=5)
</pre>

        <p>A continuación se verifica que el valor por defecto del servicio en el <em>builder</em> es el correcto. De esta manera se evitará tener que especificarlo cada vez que se quiera instanciar <em>Clima</em>.</p>

        <div class="source-code-header">climabuilder_test.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">test_constructor_con_creacion_deberia_tener_idioma_ciudad_grados_pais_url</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        idioma = <span class="orange">&quot;en&quot;</span>
        ciudad = <span class="orange">&quot;Buenos%20Aires&quot;</span>
        pais = <span class="orange">&quot;ar&quot;</span>
        grados = <span class="orange">&quot;kelvin&quot;</span>
        url_servicio = <span class="orange">&quot;http://api.openweathermap.org/data/2.5/weather&quot;</span>

        <span class="green"># Act</span>
        builder = ClimaBuilder()

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(pais, builder.pais)
        <span class="blue">self</span>.assertEqual(ciudad, builder.ciudad)
        <span class="blue">self</span>.assertEqual(idioma, builder.idioma)
        <span class="blue">self</span>.assertEqual(grados, builder.grados)
        <span class="blue">self</span>.assertEqual(url_servicio, builder.url_servicio)
</pre>

        <p>Y se agrega la <em>url</em> del servicio a los datos de la prueba:</p>

        <div class="source-code-header">climabuilder_test.py</div>
        <pre class="source-code partial-listing">
    <span class="yellow">@data</span>(
        ( <span class="gold">2172797</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="orange">&quot;english&quot;</span>, <span class="orange">&quot;fahrenheit&quot;</span>, <span class="orange">&quot;http://api.openweathermap.org/data/1.0/weather&quot;</span> ),
        ( <span class="blue">None</span>, <span class="orange">&quot;Sydney&quot;</span>, <span class="orange">&quot;au&quot;</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="orange">&quot;australian english&quot;</span>, <span class="orange">&quot;kelvin&quot;</span>, <span class="orange">&quot;http://api.openweathermap.org/data/1.5/weather&quot;</span> ),
        ( <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="gold">34.6037</span>, <span class="gold">58.3816</span>, <span class="orange">&quot;sp&quot;</span>, <span class="orange">&quot;celsius&quot;</span>, <span class="orange">&quot;http://api.openweathermap.org/data/2.0/weather&quot;</span> ),
        ( <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="orange">&quot;92730&quot;</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="orange">&quot;en&quot;</span>, <span class="orange">&quot;fahrenheit&quot;</span>, <span class="orange">&quot;http://api.openweathermap.org/data/2.5/weather&quot;</span> ),
    )
    <span class="yellow">@unpack</span>
    <span class="blue">def</span> <span class="yellow">test_build_con_varios_valores_deberia_crearlo_con_ellos</span>(<span class="cyan">self</span>, <span class="cyan">id</span>: <span class="emerald">int</span>, <span class="cyan">ciudad</span>: <span class="emerald">str</span>, <span class="cyan">pais</span>: <span class="emerald">str</span>, <span class="cyan">cp</span>: <span class="emerald">str</span>, <span class="cyan">latitud</span>: <span class="emerald">float</span>, <span class="cyan">longitud</span>: <span class="emerald">float</span>, <span class="cyan">idioma</span>: <span class="emerald">str</span>, <span class="cyan">grados</span>: <span class="emerald">str</span>, <span class="cyan">url_servicio</span>: <span class="emerald">str</span>):
        <span class="green"># Arrange</span>
        apikey = <span class="orange">&quot;abcdefg&quot;</span>

        <span class="magenta">with</span> patch.object(ClimaBuilder, <span class="orange">&quot;_crear_clima&quot;</span>, <span class="cyan">return_value</span>=<span class="blue">None</span>) <span class="magenta">as</span> mock_method:
            builder = (
                ClimaBuilder().con_apikey(apikey)
                              .con_id(id)
                              .con_servicio(url_servicio)
                              .con_ciudad(ciudad)
                              .en_pais(pais)
                              .en_codigo_postal(cp)
                              .en_coordenadas(latitud, longitud)
                              .en_idioma(idioma)
            )

            <span class="magenta">if</span> grados == <span class="orange">&quot;fahrenheit&quot;</span>:
                builder.en_fahrenheit()
            <span class="magenta">elif</span> grados == <span class="orange">&quot;celsius&quot;</span>:
                builder.en_celsius()
            <span class="magenta">else</span>:
                builder.en_kelvin()

            <span class="green"># Act</span>
            clima = builder.build()

            <span class="green"># Assert</span>
            <span class="blue">self</span>.assertIsNone(clima)
            mock_method.assert_called_once_with(apikey, id, ciudad, pais, cp, (latitud, longitud), idioma, grados, url_servicio)
</pre>
        
        <p>Ahora  se implementa la <em>url</em> en la clase <em>ClimaBuilder</em> y se modifica <em>_crear_clima</em> y <em>build</em> para agregar el argumento extra:</p>

        <div class="source-code-header">climabuilder.py</div>
        <pre class="source-code partial-listing">
<span class="blue">class</span> <span class="emerald">ClimaBuilder</span>:
    <span class="blue">def</span> <span class="yellow">__init__</span>(<span class="cyan">self</span>):
        <span class="blue">self</span>.__apikey = <span class="blue">None</span>
        <span class="blue">self</span>.__id = <span class="blue">None</span>
        <span class="blue">self</span>.__coordenadas = <span class="blue">None</span>
        <span class="blue">self</span>.__codigo_postal = <span class="blue">None</span>
        <span class="blue">self</span>.__grados = <span class="orange">&quot;kelvin&quot;</span>
        <span class="blue">self</span>.__pais = <span class="orange">&quot;ar&quot;</span>
        <span class="blue">self</span>.__ciudad = <span class="orange">&quot;Buenos%20Aires&quot;</span>
        <span class="blue">self</span>.__idioma = <span class="orange">&quot;en&quot;</span>
        <span class="blue">self</span>.__url_servicio = <span class="orange">&quot;http://api.openweathermap.org/data/2.5/weather&quot;</span>

    <span class="blue">def</span> <span class="yellow">con_servicio</span>(<span class="cyan">self</span>, <span class="cyan">url_servicio</span>: <span class="emerald">str</span>):
        <span class="blue">self</span>.__url_servicio = url_servicio
        <span class="magenta">return</span> <span class="blue">self</span>

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">url_servicio</span>(<span class="cyan">self</span>) -&gt; str:
        <span class="magenta">return</span> <span class="blue">self</span>.__url_servicio

    <span class="blue">def</span> <span class="yellow">_crear_clima</span>(<span class="cyan">self</span>, <span class="cyan">apikey</span>: <span class="emerald">str</span>, <span class="cyan">id</span>: <span class="emerald">int</span>, <span class="cyan">ciudad</span>: <span class="emerald">str</span>, <span class="cyan">pais</span>: <span class="emerald">str</span>, <span class="cyan">cp</span>: <span class="emerald">str</span>, <span class="cyan">coordenadas</span>: (<span class="emerald">float</span>, <span class="emerald">float</span>), <span class="cyan">idioma</span>: <span class="emerald">str</span>, <span class="cyan">grados</span>: <span class="emerald">str</span>, <span class="cyan">url_servicio</span>: <span class="emerald">str</span>) -&gt; Clima:
        <span class="magenta">return</span> Clima(apikey, id, ciudad, pais, cp, coordenadas, idioma, grados, url_servicio)

    <span class="blue">def</span> <span class="yellow">build</span>(<span class="cyan">self</span>):
        <span class="magenta">return</span> <span class="blue">self</span>._crear_clima(<span class="blue">self</span>.__apikey, <span class="blue">self</span>.__id, <span class="blue">self</span>.__ciudad, <span class="blue">self</span>.__pais, <span class="blue">self</span>.__codigo_postal, <span class="blue">self</span>.__coordenadas, <span class="blue">self</span>.__idioma, <span class="blue">self</span>.__grados, <span class="blue">self</span>.__url_servicio)
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py
..........................................
----------------------------------------------------------------------
Ran 42 tests in 0.001s

OK
</pre>

        <p>Se agrega el nuevo argumento al constructor de la clase <em>Clima</em> y se la expone a través de una propiedad:</p>

        <div class="source-code-header">clima.py</div>
        <pre class="source-code partial-listing">
<span class="blue">class</span> <span class="emerald">Clima</span>:
    <span class="blue">def</span> <span class="yellow">__init__</span>(<span class="cyan">self</span>, <span class="cyan">apikey</span>: <span class="emerald">str</span>, <span class="cyan">id</span>: <span class="emerald">int</span>, <span class="cyan">ciudad</span>: <span class="emerald">str</span>, <span class="cyan">pais</span>: <span class="emerald">str</span>, <span class="cyan">cp</span>: <span class="emerald">str</span>, <span class="cyan">coordenadas</span>: (<span class="emerald">float</span>, <span class="emerald">float</span>), <span class="cyan">idioma</span>: <span class="emerald">str</span>, <span class="cyan">grados</span>: <span class="emerald">str</span>, <span class="cyan">url_servicio</span>: <span class="emerald">str</span>):
        <span class="blue">self</span>.__apikey = apikey.strip() <span class="magenta">if</span> apikey <span class="blue">is not None</span> <span class="magenta">else</span> <span class="orange">&quot;&quot;</span>
        <span class="magenta">if</span> self.__apikey == <span class="orange">&quot;&quot;</span>:
            <span class="magenta">raise</span> <span class="emerald">ValueError</span>()

        <span class="blue">self</span>.__id = id
        <span class="blue">self</span>.__ciudad = ciudad
        <span class="blue">self</span>.__pais = pais
        <span class="blue">self</span>.__codigo_postal = cp
        <span class="blue">self</span>.__coordenadas = coordenadas
        <span class="blue">self</span>.__idioma = idioma
        <span class="blue">self</span>.__grados = grados
        <span class="blue">self</span>.__url_servicio = url_servicio
        <span class="blue">self</span>.__url = self._build_url()

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">url_servicio</span>(<span class="cyan">self</span>) -&gt; str:
        <span class="magenta">return</span> <span class="blue">self</span>.__url_servicio
</pre>

        <p>Por último se modifica <em>_build_url</em> dentro de la clase <em>Clima</em> para que no tenga la dirección del servidor fija:<p>

        <div class="source-code-header">clima.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">_build_url</span>(<span class="cyan">self</span>):
        url = <span class="orange">f&quot;{self.__url_servicio}?appid={self.__apikey}&quot;</span>
        <span class="magenta">if</span> <span class="blue">self</span>.__id <span class="blue">is not None</span>:
            url = <span class="orange">f&quot;{url}&amp;id={self.__id}&quot;</span>
        <span class="magenta">elif</span> <span class="blue">self</span>.__ciudad <span class="blue">is not None</span>:
            url = <span class="orange">f&quot;{url}&amp;q={self.__ciudad}&quot;</span>

            <span class="magenta">if</span> <span class="blue">self</span>.__pais <span class="blue">is not None</span>:
                url = <span class="orange">f&quot;{url},{self.__pais}&quot;</span>
        <span class="magenta">elif</span> <span class="blue">self</span>.__codigo_postal <span class="blue">is not None</span>:
            url = <span class="orange">f&quot;{url}&amp;zip={self.__codigo_postal}&quot;</span>

            <span class="magenta">if</span> <span class="blue">self</span>.__pais <span class="blue">is not None</span>:
                url = <span class="orange">f&quot;{url},{self.__pais}&quot;</span>
        <span class="magenta">elif</span> <span class="blue">self</span>.__coordenadas <span class="blue">is not None</span>:
            <span class="magenta">if</span> <span class="blue">None</span> <span class="magenta">in</span> <span class="blue">self</span>.__coordenadas:
                <span class="magenta">raise</span> <span class="emerald">ValueError</span>()

            url = <span class="orange">f&quot;{url}&amp;lat={self.__coordenadas[0]}&amp;lon={self.__coordenadas[1]}&quot;</span>
        <span class="magenta">else</span>:
            <span class="magenta">raise</span> <span class="emerald">ValueError</span>()

        <span class="magenta">if</span> <span class="blue">self</span>.__idioma <span class="blue">is not None and self</span>.__idioma != <span class="orange">&quot;&quot;</span> <span class="blue">and self</span>.__idioma != <span class="orange">&quot;en&quot;</span>:
            url = <span class="orange">f&quot;{url}&amp;lang={self.__idioma}&quot;</span>

        <span class="magenta">if</span> <span class="blue">self</span>.__grados <span class="blue">is not None</span>:
            <span class="magenta">if</span> <span class="blue">self</span>.__grados == <span class="orange">&quot;fahrenheit&quot;</span>:
                url = <span class="orange">f&quot;{url}&amp;units=imperial&quot;</span>
            <span class="magenta">elif</span> <span class="blue">self</span>.__grados == <span class="orange">&quot;celsius&quot;</span>:
                url = <span class="orange">f&quot;{url}&amp;units=metric&quot;</span>

        <span class="magenta">return</span> url
</pre>

        <p>Dentro de <em>clima_test.py</em> existen tres pruebas que llaman al constructor de <em>Clima</em> directamente en lugar de usar <em>ClassBuilder</em>, éstas deben ser modificadas para agregar la dirección del servicio a usar:</p>

        <div class="source-code-header">clima_test.py</div>
        <pre class="source-code partial-listing">
    <span class="yellow">@data</span>(
        ( <span class="gold">2172797</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, (<span class="blue">None</span>, <span class="blue">None</span>), <span class="orange">&quot;&quot;</span>, <span class="orange">&quot;fahrenheit&quot;</span>, <span class="orange">&quot;http://api.openweathermap.org/data/2.5/weather?appid=abcdefg&amp;id=2172797&amp;units=imperial&quot;</span> ),
        ( <span class="blue">None</span>, <span class="orange">&quot;Sydney&quot;</span>, <span class="orange">&quot;au&quot;</span>, <span class="blue">None</span>, (<span class="blue">None</span>, <span class="blue">None</span>), <span class="orange">&quot;fr&quot;</span>, <span class="orange">&quot;kelvin&quot;</span>, <span class="orange">&quot;http://api.openweathermap.org/data/2.5/weather?appid=abcdefg&amp;q=Sydney,au&amp;lang=fr&quot;</span> ),
        ( <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, (<span class="gold">34.6037</span>, <span class="gold">58.3816</span>), <span class="orange">&quot;es&quot;</span>, <span class="orange">&quot;celsius&quot;</span>, <span class="orange">&quot;http://api.openweathermap.org/data/2.5/weather?appid=abcdefg&amp;lat=34.6037&amp;lon=58.3816&amp;lang=es&amp;units=metric&quot;</span> ),
        ( <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="orange">&quot;94040&quot;</span>, (<span class="blue">None</span>, <span class="blue">None</span>), <span class="orange">&quot;ja&quot;</span>, <span class="orange">&quot;fahrenheit&quot;</span>, <span class="orange">&quot;http://api.openweathermap.org/data/2.5/weather?appid=abcdefg&amp;zip=94040&amp;lang=ja&amp;units=imperial&quot;</span> ),
        ( <span class="blue">None</span>, <span class="blue">None</span>, <span class="orange">&quot;ar&quot;</span>, <span class="orange">&quot;94040&quot;</span>, (<span class="blue">None</span>, <span class="blue">None</span>), <span class="orange">&quot;ja&quot;</span>, <span class="orange">&quot;fahrenheit&quot;</span>, <span class="orange">&quot;http://api.openweathermap.org/data/2.5/weather?appid=abcdefg&amp;zip=94040,ar&amp;lang=ja&amp;units=imperial&quot;</span> )
    )
    <span class="yellow">@unpack</span>
    <span class="blue">def</span> <span class="yellow">test_url_con_datos_deberia_crear_url</span>(<span class="cyan">self</span>, <span class="cyan">id</span>: <span class="emerald">int</span>, <span class="cyan">ciudad</span>: <span class="emerald">str</span>, <span class="cyan">pais</span>: <span class="emerald">str</span>, <span class="cyan">cp</span>: <span class="emerald">str</span>, <span class="cyan">coordenadas</span>: (<span class="emerald">float</span>, <span class="emerald">float</span>), <span class="cyan">idioma</span>: <span class="emerald">str</span>, <span class="cyan">grados</span>: <span class="emerald">str</span>, <span class="cyan">url</span>: <span class="emerald">str</span>):
        <span class="green"># Arrange</span>
        apikey = <span class="orange">&quot;abcdefg&quot;</span>
        url_servicio = <span class="orange">&quot;http://api.openweathermap.org/data/2.5/weather&quot;</span>

        <span class="green"># Act</span>
        clima = Clima(apikey, id, ciudad, pais, cp, coordenadas, idioma, grados, url_servicio)

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(url, clima.url)

    <span class="blue">def</span> <span class="yellow">test_constructor_con_ciudad_codigo_postal_coordenadas_id_nulas_deberia_lanzar_valueerror</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        apikey = <span class="orange">&quot;abcdefg&quot;</span>
        url_servicio = <span class="orange">&quot;http://api.openweathermap.org/data/2.5/weather&quot;</span>

        <span class="green"># Act / Assert</span>
        <span class="magenta">with</span> <span class="blue">self</span>.assertRaises(<span class="emerald">ValueError</span>) <span class="magenta">as</span> ve:
            sut = Clima(apikey, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, url_servicio)

    <span class="blue">def</span> <span class="yellow">test_constructor_con_latitud_o_longitud_nulas_y_ninguna_otra_locacion_deberia_lanzar_valueerror</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        apikey = <span class="orange">&quot;abcdefg&quot;</span>
        url_servicio = <span class="orange">&quot;http://api.openweathermap.org/data/2.5/weather&quot;</span>

        <span class="green"># Act / Assert</span>
        <span class="magenta">with</span> self.assertRaises(<span class="emerald">ValueError</span>) <span class="magenta">as</span> ve:
            sut = Clima(apikey, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, <span class="blue">None</span>, (<span class="blue">None</span>, <span class="blue">None</span>), <span class="blue">None</span>, <span class="blue">None</span>, url_servicio)
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py
...............................
----------------------------------------------------------------------
Ran 31 tests in 0.001s

OK
</pre>

        <p>Falta agregar una nueva validación: Si el constructor recibe una dirección nula o vacía debería lanzar una excepción del tipo <em>ValueError</em> similar a como lo hace con <em>API key</em>:</p>

        <div class="source-code-header">clima_test.py</div>
        <pre class="source-code partial-listing">
    <span class="yellow">@data</span>(<span class="blue">None</span>, <span class="orange">&quot;&quot;</span>, <span class="orange">&quot;&nbsp;&nbsp;&nbsp;&nbsp;&quot;</span>)
    <span class="blue">def</span> <span class="yellow">test_constructor_con_un_url_servicio_invalido_deberia_lanzar_valueerror</span>(<span class="blue">self</span>, <span class="cyan">url_servicio</span>: <span class="emerald">str</span>):
        <span class="magenta">with</span> self.assertRaises(<span class="emerald">ValueError</span>) <span class="magenta">as</span> ve:
            sut = ClimaBuilder().con_apikey(<span class="orange">&quot;abcdefg&quot;</span>).con_servicio(url_servicio).build()
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py
.......................FFF........
======================================================================
FAIL: test_constructor_con_un_url_servicio_invalido_deberia_lanzar_valueerror_1_None (__main__.ClimaUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/usuario/src/python/unit-testing/lib/python3.7/site-packages/ddt.py&quot;, line 145, in wrapper
    return func(self, *args, **kwargs)
  File &quot;clima_test.py&quot;, line 140, in test_constructor_con_un_url_servicio_invalido_deberia_lanzar_valueerror
    sut = ClimaBuilder().con_apikey(&quot;abcdefg&quot;).con_servicio(url_servicio).build()
AssertionError: ValueError not raised

======================================================================
FAIL: test_constructor_con_un_url_servicio_invalido_deberia_lanzar_valueerror_2_ (__main__.ClimaUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/usuario/src/python/unit-testing/lib/python3.7/site-packages/ddt.py&quot;, line 145, in wrapper
    return func(self, *args, **kwargs)
  File &quot;clima_test.py&quot;, line 140, in test_constructor_con_un_url_servicio_invalido_deberia_lanzar_valueerror
    sut = ClimaBuilder().con_apikey(&quot;abcdefg&quot;).con_servicio(url_servicio).build()
AssertionError: ValueError not raised

======================================================================
FAIL: test_constructor_con_un_url_servicio_invalido_deberia_lanzar_valueerror_3_____ (__main__.ClimaUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/usuario/src/python/unit-testing/lib/python3.7/site-packages/ddt.py&quot;, line 145, in wrapper
    return func(self, *args, **kwargs)
  File &quot;clima_test.py&quot;, line 140, in test_constructor_con_un_url_servicio_invalido_deberia_lanzar_valueerror
    sut = ClimaBuilder().con_apikey(&quot;abcdefg&quot;).con_servicio(url_servicio).build()
AssertionError: ValueError not raised

----------------------------------------------------------------------
Ran 34 tests in 0.001s

FAILED (failures=3)
</pre>

        <p>Se agrega la validación para que el constructor de <em>Clima</em> lance la excepción si la dirección del servidor está vacía o es nula:</p>

        <div class="source-code-header">clima.py</div>
        <pre class="source-code partial-listing">
<span class="blue">class</span> <span class="emerald">Clima</span>:
    <span class="blue">def</span> <span class="yellow">__init__</span>(<span class="cyan">self</span>, <span class="cyan">apikey</span>: <span class="emerald">str</span>, <span class="cyan">id</span>: <span class="emerald">int</span>, <span class="cyan">ciudad</span>: <span class="emerald">str</span>, <span class="cyan">pais</span>: <span class="emerald">str</span>, <span class="cyan">cp</span>: <span class="emerald">str</span>, <span class="cyan">coordenadas</span>: (<span class="emerald">float</span>, <span class="emerald">float</span>), <span class="cyan">idioma</span>: <span class="emerald">str</span>, <span class="cyan">grados</span>: <span class="emerald">str</span>, <span class="cyan">url_servicio</span>: <span class="emerald">str</span>):
        <span class="blue">self</span>.__apikey = apikey.strip() <span class="magenta">if</span> apikey <span class="blue">is not None</span> <span class="magenta">else</span> <span class="orange">&quot;&quot;</span>
        <span class="magenta">if</span> <span class="blue">self</span>.__apikey == <span class="orange">&quot;&quot;:</span>
            <span class="magenta">raise</span> <span class="emerald">ValueError</span>()

        <span class="blue">self</span>.__url_servicio = url_servicio.strip() <span class="magenta">if</span> url_servicio <span class="blue">is not None</span> <span class="magenta">else</span> <span class="orange">&quot;&quot;</span>
        <span class="magenta">if</span> <span class="blue">self</span>.__url_servicio == <span class="orange">&quot;&quot;:</span>
            <span class="magenta">raise</span> <span class="emerald">ValueError</span>()

        <span class="blue">self</span>.__id = id
        <span class="blue">self</span>.__ciudad = ciudad
        <span class="blue">self</span>.__pais = pais
        <span class="blue">self</span>.__codigo_postal = cp
        <span class="blue">self</span>.__coordenadas = coordenadas
        <span class="blue">self</span>.__idioma = idioma
        <span class="blue">self</span>.__grados = grados
        <span class="blue">self</span>.__url = self._build_url()
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 climabuilder_test.py
..........................................
----------------------------------------------------------------------
Ran 42 tests in 0.002s

OK
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py
..................................
----------------------------------------------------------------------
Ran 34 tests in 0.001s

OK
</pre>

        <p>Todo listo para implementar la conexión con el servidor de <em>OpenWeather</em>. Sin embargo las pruebas unitarias no deben acceder a servicios externos ya que deben ser tan atómicos como sea posible, repetibles y con la menor latencia posible, por consiguiente se deberá modelar sin realizar la conexión efectiva contra el servidor.</p>

        <h2>Conexión y procesamiento de la información</h2>

        <p>Hasta este momento existe una clase <em>ClimaBuilder</em> que permite crear una instancia de <em>Clima</em> la cual, internamente, prepara la <em>url</em> a la cual se conectará para obtener la información del clima. Solo queda implementar un método <em>obtener</em> que así lo haga. Sabiendo que el servidor retornará un <em>Json</em>, es posible retornar directamente la estructura obtenida para delegar su procesamiento, o procesarla internamente y retornar los datos en una nueva estructura propia.</p>

        <p>Ya que la segunda opción permite independizar al programa del formato del archivo <em>Json</em> que retorna el servidor se selecciona dicha alternativa: el método <em>obtener</em> va a devolver una nueva clase <em>Pronostico</em> que contará con un constructor que recibirá la respuesta y propiedades para acceder a los valores parseados (título, descripción, etc). También se va a sobrecargar el método mágico <em>__str__</em> para obtener los datos del clima en forma de oración.</p>

        <p>Es posible verificar que la ciudad es la pedida, sin embargo el clima cambia diariamente haciendo imposible crear una prueba eficaz. Ese es uno de los motivos por los que se utilizan ya sean datos fijos (por ejemplo, una <em>url</em> de prueba de donde siempre vengan los mismos datos) o <em>mocking</em> o simulaciones de respuestas. En el caso particular de esta aplicación se agregará a <em>ClimaBuilder</em> un nuevo método que permita definir la <em>url</em> base del sitio al cual conectarse. Esa base se transferirá a la instancia de <em>Clima</em> a través del último parámetro de su constructor. De esta manera será posible crear una prueba unitaria con la cual siempre se recibirán los mismos datos.</p>

        <p>Para evitar los factores externos se obtiene <a href="https://samples.openweathermap.org/data/2.5/weather?q=London,uk&appid=b6907d289e10d714a6e88b30761fae2">una copia</a> del <em>Json</em> del servidor de prueba de prueba y se lo utiliza para inicializar la instancia de <em>Pronostico</em> a probar. Por brevedad se muestra nuevamente el resultado final de la prueba creada:</p>

        <div class="source-code-header">pronostico_test.py</div>
        <pre class="source-code full-listing">
<span class="magenta">import</span> unittest
<span class="magenta">import</span> json
<span class="magenta">from</span> pronostico <span class="magenta">import</span> Pronostico

<span class="blue">class</span> <span class="emerald">PronosticoUnitTests</span>(<span class="emerald">unittest</span>.<span class="emerald">TestCase</span>):
    <span class="blue">def</span> <span class="yellow">test_constructor_con_json_valido_deberia_incorporarlo</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        json_data = json.loads(<span class="orange">'{&quot;coord&quot;:{&quot;lon&quot;:-0.13, &quot;lat&quot;:51.51}, &quot;weather&quot;:[{&quot;id&quot;:300, &quot;main&quot;:&quot;Drizzle&quot;, &quot;description&quot;:&quot;light intensity drizzle&quot;, &quot;icon&quot;:&quot;09d&quot;}], &quot;base&quot;:&quot;stations&quot;, &quot;main&quot;:{&quot;temp&quot;:280.32, &quot;pressure&quot;:1012, &quot;humidity&quot;:81, &quot;temp_min&quot;:279.15, &quot;temp_max&quot;:281.15}, &quot;visibility&quot;:10000, &quot;wind&quot;:{&quot;speed&quot;:4.1, &quot;deg&quot;:80}, &quot;clouds&quot;:{&quot;all&quot;:90}, &quot;dt&quot;:1485789600, &quot;sys&quot;:{&quot;type&quot;:1, &quot;id&quot;:5091, &quot;message&quot;:0.0103, &quot;country&quot;:&quot;GB&quot;, &quot;sunrise&quot;:1485762037, &quot;sunset&quot;:1485794875}, &quot;id&quot;:2643743, &quot;name&quot;:&quot;London&quot;, &quot;cod&quot;:200}'</span>)

        <span class="green"># Act</span>
        pronostico = Pronostico(json_data)

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertIsNotNone(pronostico)
        <span class="blue">self</span>.assertEqual(<span class="orange">&quot;London&quot;</span>, pronostico.ciudad)
        <span class="blue">self</span>.assertEqual((<span class="gold">51.51</span>, <span class="gold">-0.13</span>), pronostico.coordenadas)
        <span class="blue">self</span>.assertEqual(<span class="orange">&quot;Drizzle&quot;</span>, pronostico.titulo)
        <span class="blue">self</span>.assertEqual(<span class="orange">&quot;light intensity drizzle&quot;</span>, pronostico.descripcion)
        <span class="blue">self</span>.assertEqual(<span class="gold">280.32</span>, pronostico.temperatura)
        <span class="blue">self</span>.assertEqual(<span class="gold">279.15</span>, pronostico.temperatura_minima)
        <span class="blue">self</span>.assertEqual(<span class="gold">281.15</span>, pronostico.temperatura_maxima)
        <span class="blue">self</span>.assertEqual(<span class="orange">&quot;GB&quot;</span>, pronostico.pais)

<span class="magenta">if</span> <span class="cyan">__name__</span> == <span class="orange">&quot;__main__&quot;</span>:
          unittest.main()
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 pronostico_test.py
Traceback (most recent call last):
  File &quot;pronostico_test.py&quot;, line 3, in &lt;module&gt;
    from pronostico import Pronostico
ModuleNotFoundError: No module named 'pronostico'
</pre>

        <p>Con esa prueba unitaria se acaba de definir la interface pública de la clase <em>Pronostico</em>, la cual se plasma en su correspondiente archivo fuente:</p>

        <div class="source-code-header">pronostico.py</div>
        <pre class="source-code full-listing">
<span class="magenta">from</span> typing <span class="magenta">import</span> Any

<span class="blue">class</span> <span class="emerald">Pronostico</span>:
    <span class="blue">def</span> <span class="yellow">__init__</span>(<span class="cyan">self</span>, <span class="cyan">json</span>: <span class="emerald">Any</span>):
        <span class="blue">self</span>.__json_data = json
        <span class="blue">self</span>.__titulo = <span class="blue">self</span>.__json_data[<span class="orange">&quot;weather&quot;</span>][<span class="gold">0</span>][<span class="orange">&quot;main&quot;</span>]
        <span class="blue">self</span>.__descripcion = <span class="blue">self</span>.__json_data[<span class="orange">&quot;weather&quot;</span>][<span class="gold">0</span>][<span class="orange">&quot;description&quot;</span>]
        <span class="blue">self</span>.__temperatura = <span class="blue">self</span>.__json_data[<span class="orange">&quot;main&quot;</span>][<span class="orange">&quot;temp&quot;</span>]
        <span class="blue">self</span>.__tempmin = <span class="blue">self</span>.__json_data[<span class="orange">&quot;main&quot;</span>][<span class="orange">&quot;temp_min&quot;</span>]
        <span class="blue">self</span>.__tempmax = <span class="blue">self</span>.__json_data[<span class="orange">&quot;main&quot;</span>][<span class="orange">&quot;temp_max&quot;</span>]
        <span class="blue">self</span>.__ciudad = <span class="blue">self</span>.__json_data[<span class="orange">&quot;name&quot;</span>]
        <span class="blue">self</span>.__coordenadas = (<span class="blue">self</span>.__json_data[<span class="orange">&quot;coord&quot;</span>][<span class="orange">&quot;lat&quot;</span>], <span class="blue">self</span>.__json_data[<span class="orange">&quot;coord&quot;</span>][<span class="orange">&quot;lon&quot;</span>])
        <span class="blue">self</span>.__pais = <span class="blue">self</span>.__json_data[<span class="orange">&quot;sys&quot;</span>][<span class="orange">&quot;country&quot;</span>]

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">titulo</span>(<span class="cyan">self</span>) -&gt; str:
        <span class="magenta">return</span> <span class="blue">self</span>.__titulo

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">descripcion</span>(<span class="cyan">self</span>) -&gt; str:
        <span class="magenta">return</span> <span class="blue">self</span>.__descripcion

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">temperatura</span>(<span class="cyan">self</span>) -&gt; str:
        <span class="magenta">return</span> <span class="blue">self</span>.__temperatura

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">temperatura_minima</span>(<span class="cyan">self</span>) -&gt; str:
        <span class="magenta">return</span> <span class="blue">self</span>.__tempmin

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">temperatura_maxima</span>(<span class="cyan">self</span>) -&gt; str:
        <span class="magenta">return</span> <span class="blue">self</span>.__tempmax

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">ciudad</span>(<span class="cyan">self</span>) -&gt; str:
        <span class="magenta">return</span> <span class="blue">self</span>.__ciudad

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">pais</span>(<span class="cyan">self</span>) -&gt; str:
        <span class="magenta">return</span> <span class="blue">self</span>.__pais

    <span class="yellow">@</span><span class="emerald">property</span>
    <span class="blue">def</span> <span class="yellow">coordenadas</span>(<span class="cyan">self</span>) -&gt; (float, float):
        <span class="magenta">return</span> <span class="blue">self</span>.__coordenadas
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 pronostico_test.py
.
----------------------------------------------------------------------
Ran 1 test in 0.000s

OK
</pre>

        <p>Inmediatamente se puede notar que si el <em>Json</em> es nulo el programa lanzará una excepción por intentar acceder a campos que no existen. Es necesario crear una prueba para validar el caso:</p>

        <div class="source-code-header">pronostico_test.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">test_constructor_con_json_nulo_deberia_lanzar_valueerror</span>(<span class="cyan">self</span>):
        <span class="magenta">with</span> <span class="blue">self</span>.assertRaises(<span class="emerald">ValueError</span>) <span class="magenta">as</span> ve:
            sut = Pronostico(<span class="blue">None</span>)
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 pronostico_test.py
E.
======================================================================
ERROR: test_constructor_con_json_nulo_deberia_lanzar_valueerror (__main__.PronosticoUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;pronostico_test.py&quot;, line 27, in test_constructor_con_json_nulo_deberia_lanzar_valueerror
    sut = Pronostico(None)
  File "/home/usuario/src/python/clima/pronostico.py", line 6, in __init__
    self.__titulo = self.__json_data[&quot;weather&quot;][0][&quot;main&quot;]
TypeError: 'NoneType' object is not subscriptable

----------------------------------------------------------------------
Ran 2 tests in 0.000s

FAILED (errors=1)
</pre>

        <div class="source-code-header">pronostico.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">__init__</span>(<span class="cyan">self</span>, <span class="cyan">json</span>: <span class="emerald">Any</span>):
        <span class="magenta">if</span> json <span class="blue">is None</span>:
            <span class="magenta">raise</span> <span class="emerald">ValueError</span>()

        <span class="blue">self</span>.__json_data = json
        <span class="blue">self</span>.__titulo = <span class="blue">self</span>.__json_data[<span class="orange">&quot;weather&quot;</span>][<span class="gold">0</span>][<span class="orange">&quot;main&quot;</span>]
        <span class="blue">self</span>.__descripcion = <span class="blue">self</span>.__json_data[<span class="orange">&quot;weather&quot;</span>][<span class="gold">0</span>][<span class="orange">&quot;description&quot;</span>]
        <span class="blue">self</span>.__temperatura = <span class="blue">self</span>.__json_data[<span class="orange">&quot;main&quot;</span>][<span class="orange">&quot;temp&quot;</span>]
        <span class="blue">self</span>.__tempmin = <span class="blue">self</span>.__json_data[<span class="orange">&quot;main&quot;</span>][<span class="orange">&quot;temp_min&quot;</span>]
        <span class="blue">self</span>.__tempmax = <span class="blue">self</span>.__json_data[<span class="orange">&quot;main&quot;</span>][<span class="orange">&quot;temp_max&quot;</span>]
        <span class="blue">self</span>.__ciudad = <span class="blue">self</span>.__json_data[<span class="orange">&quot;name&quot;</span>]
        <span class="blue">self</span>.__coordenadas = (<span class="blue">self</span>.__json_data[<span class="orange">&quot;coord&quot;</span>][<span class="orange">&quot;lat&quot;</span>], <span class="blue">self</span>.__json_data[<span class="orange">&quot;coord&quot;</span>][<span class="orange">&quot;lon&quot;</span>])
        <span class="blue">self</span>.__pais = <span class="blue">self</span>.__json_data[<span class="orange">&quot;sys&quot;</span>][<span class="orange">&quot;country&quot;</span>]
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 pronostico_test.py
..
----------------------------------------------------------------------
Ran 2 tests in 0.000s

OK
</pre>

        <p>Solo queda reescribir el método mágico <em>__str__</em> para que imprima de manera prolija la información del clima. Se agrega una nueva prueba en <em>pronostico_test.py</em> y luego se implementa la solución en <em>pronostico.py</em>:</p>

        <div class="source-code-header">pronostico_test.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span>  <span class="yellow">test___str__con_json_valido_deberia_generar_oracion</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        json_data = json.loads(<span class="orange">'{&quot;coord&quot;:{&quot;lon&quot;:-0.13, &quot;lat&quot;:51.51}, &quot;weather&quot;:[{&quot;id&quot;:300,&quot;main&quot;:&quot;Drizzle&quot;, &quot;description&quot;:&quot;light intensity drizzle&quot;, &quot;icon&quot;:&quot;09d&quot;}], &quot;base&quot;:&quot;stations&quot;, &quot;main&quot;:{&quot;temp&quot;:280.32, &quot;pressure&quot;:1012, &quot;humidity&quot;:81, &quot;temp_min&quot;:279.15, &quot;temp_max&quot;:281.15}, &quot;visibility&quot;:10000, &quot;wind&quot;:{&quot;speed&quot;:4.1, &quot;deg&quot;:80}, &quot;clouds&quot;:{&quot;all&quot;:90}, &quot;dt&quot;:1485789600, &quot;sys&quot;:{&quot;type&quot;:1, &quot;id&quot;:5091, &quot;message&quot;:0.0103, &quot;country&quot;:&quot;GB&quot;, &quot;sunrise&quot;:1485762037, &quot;sunset&quot;:1485794875}, &quot;id&quot;:2643743, &quot;name&quot;:&quot;London&quot;, &quot;cod&quot;:200}'</span>)
        pronostico = Pronostico(json_data)

        <span class="green"># Act</span>
        resultado = <span class="emerald">str</span>(pronostico)

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertEqual(<span class="orange">&quot;London (GB) currently has light intensity drizzle with a temperature of 280.32F.&quot;</span>, resultado);
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 pronostico_test.py 
F..
======================================================================
FAIL: test___str__con_json_valido_deberia_generar_oracion (__main__.PronosticoUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;pronostico_test.py&quot;, line 37, in test___str__con_json_valido_deberia_generar_oracion
    self.assertEqual(&quot;London currently has light intensity drizzle, a temperature of 280.32F.&quot;, resultado);
AssertionError: 'London currently has light intensity drizzle, a temperature of 280.32F.' != '&lt;pronostico.Pronostico object at 0x7fc72ce4ded0&gt;'
- London currently has light intensity drizzle, a temperature of 280.32F.
+ &lt;pronostico.Pronostico object at 0x7fc72ce4ded0&gt;


----------------------------------------------------------------------
Ran 3 tests in 0.000s

FAILED (failures=1)
</pre>
        <p>Por defecto se está imprimiendo la dirección en memoria de la instancia de <em>Pronostico</em>. Mediante la siguiente implementación se modifica dicho comportamiento.</p>

        <div class="source-code-header">pronostico.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">__str__</span>(<span class="cyan">self</span>):
        <span class="magenta">return</span> <span class="blue">f</span><span class="orange">&quot;{self.ciudad} ({self.pais}) currently has {self.descripcion} with a temperature of {self.temperatura}F.&quot;</span>
</pre>

        <pre class="source-code partial-listing">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 pronostico_test.py 
...
----------------------------------------------------------------------
Ran 3 tests in 0.000s

OK
</pre>

        <p>En este momento la &quot;F&quot; de Fahrenheit está fija ya que ese dato no viaja en el <em>Json</em> de la respuesta, por consiguiente hay que pasársela a la clase al momento de la creación, siendo necesario modificar las pruebas unitarias de <em>Pronostico</em> para quedar como sigue:</p>

        <div class="source-code-header">pronostico_test.py</div>
        <pre class="source-code">
<span class="magenta">import</span> unittest
<span class="magenta">import</span> json
<span class="magenta">from</span> pronostico <span class="magenta">import</span> Pronostico

<span class="blue">class</span> <span class="emerald">PronosticoUnitTests</span>(<span class="emerald">unittest</span>.<span class="emerald">TestCase</span>):
    <span class="blue">def</span> <span class="yellow">test_constructor_con_json_valido_deberia_incorporarlo</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        json_data = json.loads(<span class="orange">'{&quot;coord&quot;:{&quot;lon&quot;:-0.13, &quot;lat&quot;:51.51}, &quot;weather&quot;:[{&quot;id&quot;:300, &quot;main&quot;:&quot;Drizzle&quot;, &quot;description&quot;:&quot;light intensity drizzle&quot;, &quot;icon&quot;:&quot;09d&quot;}], &quot;base&quot;:&quot;stations&quot;, &quot;main&quot;:{&quot;temp&quot;:280.32, &quot;pressure&quot;:1012, &quot;humidity&quot;:81, &quot;temp_min&quot;:279.15, &quot;temp_max&quot;:281.15}, &quot;visibility&quot;:10000, &quot;wind&quot;:{&quot;speed&quot;:4.1, &quot;deg&quot;:80}, &quot;clouds&quot;:{&quot;all&quot;:90}, &quot;dt&quot;:1485789600, &quot;sys&quot;:{&quot;type&quot;:1, &quot;id&quot;:5091, &quot;message&quot;:0.0103, &quot;country&quot;:&quot;GB&quot;, &quot;sunrise&quot;:1485762037, &quot;sunset&quot;:1485794875}, &quot;id&quot;:2643743, &quot;name&quot;:&quot;London&quot;, &quot;cod&quot;:200}'</span>)

        <span class="green"># Act</span>
        pronostico = Pronostico(json_data, <span class="orange">&quot;fahrenheit&quot;</span>)

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertIsNotNone(pronostico)
        <span class="blue">self</span>.assertEqual(<span class="orange">&quot;London&quot;</span>, pronostico.ciudad)
        <span class="blue">self</span>.assertEqual((<span class="gold">51.51</span>, <span class="gold">-0.13</span>), pronostico.coordenadas)
        <span class="blue">self</span>.assertEqual(<span class="orange">&quot;Drizzle&quot;</span>, pronostico.titulo)
        <span class="blue">self</span>.assertEqual(<span class="orange">&quot;light intensity drizzle&quot;</span>, pronostico.descripcion)
        <span class="blue">self</span>.assertEqual(<span class="gold">280.32</span>, pronostico.temperatura)
        <span class="blue">self</span>.assertEqual(<span class="gold">279.15</span>, pronostico.temperatura_minima)
        <span class="blue">self</span>.assertEqual(<span class="gold">281.15</span>, pronostico.temperatura_maxima)
        <span class="blue">self</span>.assertEqual(<span class="orange">&quot;GB&quot;</span>, pronostico.pais)


    <span class="blue">def</span> <span class="yellow">test_constructor_con_json_nulo_deberia_lanzar_valueerror</span>(<span class="cyan">self</span>):
        <span class="magenta">with</span> <span class="blue">self</span>.assertRaises(<span class="emerald">ValueError</span>) <span class="magenta">as</span> ve:
            sut = Pronostico(<span class="blue">None</span>, <span class="orange">&quot;fahrenheit&quot;</span>)

    <span class="blue">def</span>  <span class="yellow">test___str__con_json_valido_deberia_generar_oracion</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        json_data = json.loads(<span class="orange">'{&quot;coord&quot;:{&quot;lon&quot;:-0.13, &quot;lat&quot;:51.51}, &quot;weather&quot;:[{&quot;id&quot;:300, &quot;main&quot;:&quot;Drizzle&quot;, &quot;description&quot;:&quot;light intensity drizzle&quot;, &quot;icon&quot;:&quot;09d&quot;}], &quot;base&quot;:&quot;stations&quot;, &quot;main&quot;:{&quot;temp&quot;:280.32, &quot;pressure&quot;:1012, &quot;humidity&quot;:81, &quot;temp_min&quot;:279.15, &quot;temp_max&quot;:281.15}, &quot;visibility&quot;:10000, &quot;wind&quot;:{&quot;speed&quot;:4.1, &quot;deg&quot;:80}, &quot;clouds&quot;:{&quot;all&quot;:90}, &quot;dt&quot;:1485789600, &quot;sys&quot;:{&quot;type&quot;:1, &quot;id&quot;:5091, &quot;message&quot;:0.0103, &quot;country&quot;:&quot;GB&quot;, &quot;sunrise&quot;:1485762037, &quot;sunset&quot;:1485794875}, &quot;id&quot;:2643743, &quot;name&quot;:&quot;London&quot;, &quot;cod&quot;:200}'</span>)
        pronostico = Pronostico(json_data, <span class="orange">&quot;fahrenheit&quot;</span>)

        <span class="green"># Act</span>
        resultado = <span class="emerald">str</span>(pronostico)

        <span class="green"># Result</span>
        <span class="blue">self</span>.assertEqual(<span class="orange">&quot;London (GB) currently has light intensity drizzle with a temperature of 280.32F.&quot;</span>, resultado);

<span class="magenta">if</span> <span class="cyan">__name__</span> == <span class="orange">&quot;__main__&quot;</span>:
          unittest.main()
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 pronostico_test.py 
EEE
======================================================================
ERROR: test___str__con_json_valido_deberia_generar_oracion (__main__.PronosticoUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;pronostico_test.py&quot;, line 32, in test___str__con_json_valido_deberia_generar_oracion
    pronostico = Pronostico(json_data, &quot;imperial&quot;)
TypeError: __init__() takes 2 positional arguments but 3 were given

======================================================================
ERROR: test_constructor_con_json_nulo_deberia_lanzar_valueerror (__main__.PronosticoUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;pronostico_test.py&quot;, line 27, in test_constructor_con_json_nulo_deberia_lanzar_valueerror
    sut = Pronostico(None, &quot;imperial&quot;)
TypeError: __init__() takes 2 positional arguments but 3 were given

======================================================================
ERROR: test_constructor_con_json_valido_deberia_incorporarlo (__main__.PronosticoUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;pronostico_test.py&quot;, line 11, in test_constructor_con_json_valido_deberia_incorporarlo
    pronostico = Pronostico(json_data, &quot;imperial&quot;)
TypeError: __init__() takes 2 positional arguments but 3 were given

----------------------------------------------------------------------
Ran 3 tests in 0.000s

FAILED (errors=3)
</pre>

        <div class="source-code-header">pronostico.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">__init__</span>(<span class="cyan">self</span>, <span class="cyan">json</span>: <span class="emerald">Any</span>, <span class="cyan">grados</span>: <span class="emerald">str</span>):
        <span class="magenta">if</span> json <span class="blue">is None</span>:
            <span class="magenta">raise</span> <span class="emerald">ValueError</span>()

        <span class="blue">self</span>.__json_data = json
        <span class="blue">self</span>.__titulo = <span class="blue">self</span>.__json_data[<span class="orange">&quot;weather&quot;</span>][<span class="gold">0</span>][<span class="orange">&quot;main&quot;</span>]
        <span class="blue">self</span>.__descripcion = <span class="blue">self</span>.__json_data[<span class="orange">&quot;weather&quot;</span>][<span class="gold">0</span>][<span class="orange">&quot;description&quot;</span>]
        <span class="blue">self</span>.__temperatura = <span class="blue">self</span>.__json_data[<span class="orange">&quot;main&quot;</span>][<span class="orange">&quot;temp&quot;</span>]
        <span class="blue">self</span>.__tempmin = <span class="blue">self</span>.__json_data[<span class="orange">&quot;main&quot;</span>][<span class="orange">&quot;temp_min&quot;</span>]
        <span class="blue">self</span>.__tempmax = <span class="blue">self</span>.__json_data[<span class="orange">&quot;main&quot;</span>][<span class="orange">&quot;temp_max&quot;</span>]
        <span class="blue">self</span>.__ciudad = <span class="blue">self</span>.__json_data[<span class="orange">&quot;name&quot;</span>]
        <span class="blue">self</span>.__coordenadas = (<span class="blue">self</span>.__json_data[<span class="orange">&quot;coord&quot;</span>][<span class="orange">&quot;lat&quot;</span>], <span class="blue">self</span>.__json_data[<span class="orange">&quot;coord&quot;</span>][<span class="orange">&quot;lon&quot;</span>])
        <span class="blue">self</span>.__pais = <span class="blue">self</span>.__json_data[<span class="orange">&quot;sys&quot;</span>][<span class="orange">&quot;country&quot;</span>]
        <span class="blue">self</span>.__grados = grados
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 pronostico_test.py
...
----------------------------------------------------------------------
Ran 3 tests in 0.000s

OK
</pre>

        <p>Las pruebas pasaron, sin embargo la &quot;F&quot; de la temperatura aún está fija por lo que es necesario modificar la prueba <em class="breakable-word">test___str__con_json_valido_deberia_generar_oracion</em> para agregarle una lista de datos y cambiar dinámicamente el texto. Primero hay que agregar una referencia al módulo <em>ddt</em> para luego modificar el resto.</p>
        <div class="source-code-header">pronostico_test.py</div>
        <pre class="source-code partial-listing">
<span class="magenta">import</span> unittest
<span class="magenta">import</span> json
<span class="magenta">from</span> ddt <span class="magenta">import</span> ddt, data
<span class="magenta">from</span> pronostico <span class="magenta">import</span> Pronostico

<span class="yellow">@ddt</span>
<span class="blue">class</span> <span class="emerald">PronosticoUnitTests</span>(<span class="emerald">unittest</span>.<span class="emerald">TestCase</span>):
</pre>

        <div class="source-code-header">pronostico_test.py</div>
        <pre class="source-code partial-listing">
    <span class="yellow">@data</span>((<span class="orange">&quot;kelvin&quot;</span>, <span class="orange">&quot;K&quot;</span>), (<span class="orange">&quot;imperial&quot;</span>, <span class="orange">&quot;F&quot;</span>), (<span class="orange">&quot;metric&quot;</span>, <span class="orange">&quot;C&quot;</span>))
    <span class="blue">def</span> <span class="yellow">test___str__con_json_valido_deberia_generar_oracion</span>(<span class="cyan">self</span>, <span class="cyan">grados</span>: (<span class="emerald">str</span>, <span class="emerald">str</span>)):
        <span class="green"># Arrange</span>
        json_data = json.loads(<span class="orange">'{&quot;coord&quot;:{&quot;lon&quot;:-0.13, &quot;lat&quot;:51.51}, &quot;weather&quot;:[{&quot;id&quot;:300, &quot;main&quot;:&quot;Drizzle&quot;, &quot;description&quot;:&quot;light intensity drizzle&quot;, &quot;icon&quot;:&quot;09d&quot;}], &quot;base&quot;:&quot;stations&quot;, &quot;main&quot;:{&quot;temp&quot;:280.32, &quot;pressure&quot;:1012, &quot;humidity&quot;:81, &quot;temp_min&quot;:279.15, &quot;temp_max&quot;:281.15}, &quot;visibility&quot;:10000, &quot;wind&quot;:{&quot;speed&quot;:4.1, &quot;deg&quot;:80}, &quot;clouds&quot;:{&quot;all&quot;:90}, &quot;dt&quot;:1485789600, &quot;sys&quot;:{&quot;type&quot;:1, &quot;id&quot;:5091, &quot;message&quot;:0.0103, &quot;country&quot;:&quot;GB&quot;, &quot;sunrise&quot;:1485762037, &quot;sunset&quot;:1485794875}, &quot;id&quot;:2643743, &quot;name&quot;:&quot;London&quot;, &quot;cod&quot;:200}'</span>)
        pronostico = Pronostico(json_data, grados[<span class="gold">0</span>])

        <span class="green"># Act</span>
        resultado = <span class="emerald">str</span>(pronostico)

        <span class="green"># Result</span>
        <span class="blue">self</span>.assertEqual(<span class="blue">f</span><span class="orange">&quot;London (GB) currently has light intensity drizzle with a temperature of 280.32{grados[1]}.&quot;</span>, resultado);
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 pronostico_test.py
F.F..
======================================================================
FAIL: test___str__con_json_valido_deberia_generar_oracion_1___kelvin____K__ (__main__.PronosticoUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/usuario/src/python/unit-testing/lib/python3.7/site-packages/ddt.py&quot;, line 145, in wrapper
    return func(self, *args, **kwargs)
  File &quot;pronostico_test.py&quot;, line 41, in test___str__con_json_valido_deberia_generar_oracion
    self.assertEqual(f&quot;London (GB) currently has light intensity drizzle with a temperature of 280.32{grados[1]}.&quot;, resultado);
AssertionError: 'Lond[14 chars]tly has light intensity drizzle with a temperature of 280.32K.' != 'Lond[14 chars]tly has light intensity drizzle with a temperature of 280.32F.'
- London (GB) currently has light intensity drizzle with a temperature of 280.32K.
?                                                                               ^
+ London (GB) currently has light intensity drizzle with a temperature of 280.32F.
?                                                                               ^


======================================================================
FAIL: test___str__con_json_valido_deberia_generar_oracion_3___metric____C__ (__main__.PronosticoUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/home/usuario/src/python/unit-testing/lib/python3.7/site-packages/ddt.py&quot;, line 145, in wrapper
    return func(self, *args, **kwargs)
  File &quot;pronostico_test.py&quot;, line 41, in test___str__con_json_valido_deberia_generar_oracion
    self.assertEqual(f&quot;London (GB) currently has light intensity drizzle with a temperature of 280.32{grados[1]}.&quot;, resultado);
AssertionError: 'Lond[14 chars]tly has light intensity drizzle with a temperature of 280.32C.' != 'Lond[14 chars]tly has light intensity drizzle with a temperature of 280.32F.'
- London (GB) currently has light intensity drizzle with a temperature of 280.32C.
?                                                                               ^
+ London (GB) currently has light intensity drizzle with a temperature of 280.32F.
?                                                                               ^


----------------------------------------------------------------------
Ran 5 tests in 0.001s

FAILED (failures=2)
</pre>

        <p>Una vez verificado el error, se procede a solucionarlo:</p>

        <div class="source-code-header">pronostico.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">_visualizar_grados</span>(<span class="cyan">self</span>):
        <span class="magenta">if</span> <span class="blue">self</span>.__grados == <span class="orange">&quot;celsius&quot;</span>:
            <span class="magenta">return</span> <span class="orange">&quot;C&quot;</span>
        <span class="magenta">elif</span> <span class="blue">self</span>.__grados == <span class="orange">&quot;fahrenheit&quot;</span>:
            <span class="magenta">return</span> <span class="orange">&quot;F&quot;</span>
        <span class="magenta">else</span>:
            <span class="magenta">return</span> <span class="orange">&quot;K&quot;</span>

    <span class="blue">def</span> <span class="yellow">__str__</span>(<span class="cyan">self</span>):
        <span class="magenta">return</span> <span class="blue">f</span><span class="orange">&quot;{self.ciudad} ({self.pais}) currently has {self.descripcion} with a temperature of {self.temperatura}{self._visualizar_grados()}.&quot;</span>
</pre>

        <pre class="source-code partial-listing">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 pronostico_test.py
.....
----------------------------------------------------------------------
Ran 5 tests in 0.000s

OK
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 climabuilder_test.py
..........................................
----------------------------------------------------------------------
Ran 42 tests in 0.001s

OK
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py
..................................
----------------------------------------------------------------------
Ran 34 tests in 0.001s

OK
</pre>

        <h2 id="integrationtest">Prueba de integración</h2>

        <p>La < href="https://es.wikipedia.org/wiki/Prueba_de_integraci%C3%B3n">prueba de integración</a> se realiza para comprobar que los diferentes módulos del programa se interrelacionen correctamente entre ellos. Por ser este proyecto simple, la única prueba de integración que podría existir es el proceso completo del método <em>obtener</em> ya que necesita de dos de las tres clases (<em>Clima</em> y <em>Pronostico</em>), aunque desde la prueba se necesita el <em>builder</em> también.</p>
        
        <p>Para realizar dicha prueba, por ejemplo, se debe utilizar a <em>ClimaBuilder</em> para crear el objeto <em>Clima</em>, luego se invoca al método <em>obtener</em> para que retorne una instancia de la clase <em>Pronostico</em> a la cual se le va a inyectar la respuesta del servidor.</p>

        <p>Para la implementación del método que realizará la llamada al servidor se crea una nueva prueba:</p>

        <div class="source-code-header">clima_test.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">test_obtener_con_el_objeto_creado_deberia_obtener_json</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        clima = (
            ClimaBuilder().con_apikey(<span class="orange">&quot;abcdefg&quot;</span>)
                          .con_ciudad(&quot;London&quot;)
                          .en_pais(&quot;uk&quot;)
                          .con_servicio(&quot;http://api.openweathermap.org/data/2.5/weather&quot;)
                          .build()
        )
        <span class="green"># Act</span>
        pronostico = clima.obtener()

        <span class="green"># Assert</span>
        <span class="blue">self</span>.assertIsNotNone(pronostico)
        <span class="blue">self</span>.assertEqual(clima.ciudad, pronostico.ciudad)
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py
.............................E.....
======================================================================
ERROR: test_obtener_con_el_objeto_creado_deberia_obtener_json (__main__.ClimaUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;clima_test.py&quot;, line 152, in test_obtener_con_el_objeto_creado_deberia_obtener_json
    pronostico = clima.obtener()
AttributeError: 'Clima' object has no attribute 'obtener'

----------------------------------------------------------------------
Ran 35 tests in 0.001s

FAILED (errors=1)
</pre>
        <p>Y se implementa la solución más simple, importando <em>Pronostico</em>:</p>

        <div class="source-code-header">clima.py</div>
        <pre class="source-code partial-listing">
        <span class="magenta">import</span> urllib.request, json
        <span class="magenta">from</span> pronostico <span class="magenta">import</span> Pronostico
        <span class="magenta">from</span> typing <span class="magenta">import</span> Any
</pre>

        <div class="source-code-header">clima.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">obtener</span>(<span class="cyan">self</span>) -&gt; Pronostico:
        <span class="magenta">try</span>:
            <span class="magenta">with</span> urllib.request.urlopen(<span class="blue">self</span>.__url) <span class="magenta">as</span> url:
                data = url.read().decode()

                <span class="magenta">try</span>: 
                    json_data = json.loads(data)
                    <span class="magenta">return</span> Pronostico(json_data, <span class="blue">self</span>.__grados)
                <span class="magenta">except</span>:
                    return <span class="blue">None</span>
        <span class="magenta">except</span>:
            return <span class="blue">None</span>
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py
.............................F.....
======================================================================
FAIL: test_obtener_con_el_objeto_creado_deberia_obtener_json (__main__.ClimaUnitTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;clima_test.py&quot;, line 155, in test_obtener_con_el_objeto_creado_deberia_obtener_json
    self.assertIsNotNone(pronostico)
AssertionError: unexpectedly None

----------------------------------------------------------------------
Ran 35 tests in 0.502s

FAILED (failures=1)
</pre>

        <p>El problema que sucedió es que se intentó conectar al servidor de producción con una <em>API key</em> incorrecta, por consiguiente no es posible conocer si el método en sí funcionó o no. La mejor solución es crear nuevamente un <em>mock</em> u objeto simulado para tener una respuesta fija que podamos inyectar. Sin embargo, antes se debe dividir al método <em>obtener</em> en dos o más secciones para poder inyectar únicamente la respuesta del servidor.</p>

        <div class="source-code-header">clima.py</div>
        <pre class="source-code partial-listing">
    <span class="blue">def</span> <span class="yellow">obtener</span>(<span class="cyan">self</span>) -&gt; Pronostico:
        data = <span class="blue">self</span>._get_server_data(<span class="blue">self</span>.__url)

        <span class="magenta">if</span> data:
            json = <span class="blue">self</span>._deserialize_json(data)

            <span class="magenta">if</span> json:
                <span class="magenta">return</span> Pronostico(json, <span class="blue">self</span>.__grados)

    <span class="blue">def</span> <span class="yellow">_deserialize_json</span>(<span class="cyan">self</span>, <span class="cyan">data</span>: <span class="green">str</span>) -&gt; Any:
        <span class="magenta">try</span>:
            <span class="magenta">return</span> json.loads(data)
        <span class="magenta">except</span>:
            <span class="magenta">return</span> <span class="blue">None</span>

    <span class="blue">def</span> <span class="yellow">_get_server_data</span>(<span class="cyan">self</span>, <span class="cyan">link</span>: <span class="emerald">str</span>) -&gt; str:
        <span class="magenta">try</span>:
            <span class="magenta">with</span> urllib.request.urlopen(link) <span class="magenta">as</span> url:
                data = url.read().decode()
        <span class="magenta">except</span>:
            data = <span class="blue">None</span>

        <span class="magenta">return</span> data
</pre>

        <p>Ahora que se ha dividido a la obtención de datos del procesamiento, es posible crear una nueva prueba que inyecte el <em>Json</em> de ejemplo. Primero se importan los módulos correspondientes:</p>

        <div class="source-code-header">clima_test.py</div>
        <pre class="source-code partial-listing">
<span class="magenta">import</span> unittest
<span class="magenta">from</span> unittest.mock <span class="magenta">import</span> patch
<span class="magenta">from</span> ddt <span class="magenta">import</span> ddt, data, unpack
<span class="magenta">from</span> climabuilder <span class="magenta">import</span> ClimaBuilder
<span class="magenta">from</span> clima <span class="magenta">import</span> Clima
</pre>

        <p>Y se reescribe la prueba para que utilice simulación:</p>

        <div class="source-code-header">clima_test.py</div>
        <pre class="source-code">
    <span class="blue">def</span> <span class="yellow">test_obtener_con_el_objeto_creado_deberia_obtener_json</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        respuesta = <span class="orange">'{&quot;coord&quot;:{&quot;lon&quot;:-0.13, &quot;lat&quot;:51.51}, &quot;weather&quot;:[{&quot;id&quot;:300, &quot;main&quot;:&quot;Drizzle&quot;, &quot;description&quot;:&quot;light intensity drizzle&quot;, &quot;icon&quot;:&quot;09d&quot;}], &quot;base&quot;:&quot;stations&quot;, &quot;main&quot;:{&quot;temp&quot;:280.32, &quot;pressure&quot;:1012, &quot;humidity&quot;:81, &quot;temp_min&quot;:279.15, &quot;temp_max&quot;:281.15}, &quot;visibility&quot;:10000, &quot;wind&quot;:{&quot;speed&quot;:4.1, &quot;deg&quot;:80}, &quot;clouds&quot;:{&quot;all&quot;:90}, &quot;dt&quot;:1485789600, &quot;sys&quot;:{&quot;type&quot;:1, &quot;id&quot;:5091, &quot;message&quot;:0.0103, &quot;country&quot;:&quot;GB&quot;, &quot;sunrise&quot;:1485762037, &quot;sunset&quot;:1485794875}, &quot;id&quot;:2643743, &quot;name&quot;:&quot;London&quot;, &quot;cod&quot;:200}'</span>

        <span class="magenta">with</span> patch.object(Clima, <span class="orange">&quot;_get_server_data&quot;</span>, <span class="cyan">return_value</span>=respuesta) <span class="magenta">as</span> mock_method:
            clima = (
                ClimaBuilder().con_apikey(<span class="orange">&quot;abcdefg&quot;</span>)
                              .con_ciudad(<span class="orange">&quot;London&quot;</span>)
                              .en_pais(<span class="orange">&quot;uk&quot;</span>)
                              .con_servicio(<span class="orange">&quot;http://api.openweathermap.org/data/2.5/weather&quot;</span>)
                              .build()
            )

            <span class="green"># Act</span>
            pronostico = clima.obtener()

            <span class="green"># Assert</span>
            <span class="blue">self</span>.assertIsNotNone(pronostico)
            <span class="blue">self</span>.assertEqual(clima.ciudad, pronostico.ciudad)
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 clima_test.py
...................................
----------------------------------------------------------------------
Ran 35 tests in 0.001s

OK
</pre>

        <p>Nuevamente, por ser un programa simple la prueba de integración no costará más recursos (tiempo o procesamiento) y puede ser parte de las pruebas unitarias. Pero en un sistema profesional debería permanecer separado del resto de las pruebas ya que se suponen son pruebas mucho más pesadas y sólo deberían ejecutarse al combinar módulos durante el proceso de integración.</p>

        <h2 id="systemtest">Prueba de sistema</h2>

        <p>Probar ya no un método específico sino el programa entero y su interacción con el resto de los recursos externos (en nuestro caso, que pueda comunicarse con un servidor externo para extraer la información) se denomina <em>prueba de sistema</em>. La prueba de sistema es la última oportunidad que tienen los desarrolladores de capturar errores en el programa antes de que los clientes puedan encontrarlas en las <em>pruebas de validación</em>.</p>

        <p>En este programa, la prueba de sistema es igual a la prueba de integración excepto que no tendrá ninguna simulación, se conectará a los recursos externos (en este caso, a la <em>API</em> externa). Al igual que la prueba de integración debe estar separada del resto. Por consiguiente, se creará un nuevo archivo, <em>sistema_test.py</em>. Como al llegar a este paso el sistema ya está completo, no debería ser necesario modificar el código fuente.</p>

        <div class="source-code-header">sistema_test.py</div>
        <pre class="source-code">
<span class="magenta">import</span> unittest
<span class="magenta">from</span> climabuilder <span class="magenta">import</span> ClimaBuilder
<span class="magenta">from</span> clima <span class="magenta">import</span> Clima
<span class="magenta">from</span> pronostico <span class="magenta">import</span> Pronostico

<span class="blue">class</span> <span class="emerald">SistemaTests</span>(<span class="emerald">unittest</span>.<span class="emerald">TestCase</span>):
    <span class="blue">def</span> <span class="yellow">test_con_el_sistema_completo_deberia_funcionar</span>(<span class="cyan">self</span>):
        <span class="green"># Arrange</span>
        clima = (
            ClimaBuilder().con_apikey(<span class="orange">&quot;b6907d289e10d714a6e88b30761fae2&quot;</span>)
                          .con_ciudad(<span class="orange">&quot;London&quot;</span>)
                          .en_pais(<span class="orange">&quot;uk&quot;</span>)
                          .con_servicio(<span class="orange">&quot;https://samples.openweathermap.org/data/2.5/weather&quot;</span>)
                          .build()
        )

        <span class="green"># Act</span>
        pronostico = clima.obtener()

        <span class="green"># Assert</span>
        self.assertIsNotNone(pronostico)
        self.assertEqual(clima.ciudad, pronostico.ciudad)
        self.assertEqual((<span class="gold">51.51</span>, <span class="gold">-0.13</span>), pronostico.coordenadas)
        self.assertEqual(<span class="orange">&quot;Drizzle&quot;</span>, pronostico.titulo)
        self.assertEqual(<span class="orange">&quot;light intensity drizzle&quot;</span>, pronostico.descripcion)
        self.assertEqual(<span class="gold">280.32</span>, pronostico.temperatura)
        self.assertEqual(<span class="gold">279.15</span>, pronostico.temperatura_minima)
        self.assertEqual(<span class="gold">281.15</span>, pronostico.temperatura_maxima)
        self.assertEqual(<span class="orange">&quot;GB&quot;</span>, pronostico.pais)

<span class="magenta">if</span> <span class="cyan">__name__</span> == <span class="orange">&quot;__main__&quot;</span>:
    unittest.main()
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 sistema_test.py
.
----------------------------------------------------------------------
Ran 1 test in 1.012s

OK
</pre>


	    <h2 id="testsuite">Test suites</h2>

    	<p>Hasta este momento las pruebas han sido agrupadas en casos de pruebas o <em>test cases</em>. Sin embargo, existe una agrupación mayor: <em>test suites</em>. Un <em>test suite</em> puede agrupar a varios <em>test cases</em>, y un <em>test case</em> puede agrupar a varios <em>test methods</em> o métodos de prueba. Los <em>suites</em> pueden agrupar casos de distintos grupos de pruebas, por ejemplo, un <em>suite</em> podría contener todas las pruebas referentes a climas por ciudad, mientras que otro podría contener pruebas referentes con mapas de climas.</p>

        <div class="source-code-header">full_test.py</div>
        <pre class="source-code">
<span class="magenta">import</span> unittest
<span class="magenta">import</span> clima_test
<span class="magenta">import</span> climabuilder_test
<span class="magenta">import</span> pronostico_test
<span class="magenta">import</span> sistema_test

<span class="magenta">if</span> <span class="cyan">__name__</span> == <span class="orange">&quot;__main__&quot;</span>:
    suite = unittest.TestSuite()

    suite.addTest(unittest.makeSuite(clima_test.ClimaUnitTests))
    suite.addTest(unittest.makeSuite(climabuilder_test.ClimaBuilderUnitTests))
    suite.addTest(unittest.makeSuite(pronostico_test.PronosticoUnitTests))
    suite.addTest(unittest.makeSuite(sistema_test.SistemaTests))

    unittest.TextTestRunner(<span class="cyan">verbosity</span>=3).run(suite)
</pre>

        <pre class="source-code">
(unit-testing) <span class="green">usuario@desktop</span>:<span class="blue">~/src/python/clima</span>$ python3 full_test.py
test_constructor_con_celsius_deberia_incorporarlo (clima_test.ClimaUnitTests) ... ok
test_constructor_con_ciudad_codigo_postal_coordenadas_id_nulas_deberia_lanzar_valueerror (clima_test.ClimaUnitTests) ... ok
test_constructor_con_ciudad_valida_deberia_incorporarla (clima_test.ClimaUnitTests) ... ok
test_constructor_con_cualquier_codigo_postal_deberia_incorporarlo_1_None (clima_test.ClimaUnitTests) ... ok
test_constructor_con_cualquier_codigo_postal_deberia_incorporarlo_2_ (clima_test.ClimaUnitTests) ... ok
test_constructor_con_cualquier_codigo_postal_deberia_incorporarlo_3_13233 (clima_test.ClimaUnitTests) ... ok
test_constructor_con_cualquier_coordenadas_deberia_incorporarlo (clima_test.ClimaUnitTests) ... ok
test_constructor_con_cualquier_id_deberia_incorporarlo_1_None (clima_test.ClimaUnitTests) ... ok
test_constructor_con_cualquier_id_deberia_incorporarlo_2__11 (clima_test.ClimaUnitTests) ... ok
test_constructor_con_cualquier_id_deberia_incorporarlo_3_0 (clima_test.ClimaUnitTests) ... ok
test_constructor_con_cualquier_id_deberia_incorporarlo_4_10 (clima_test.ClimaUnitTests) ... ok
test_constructor_con_cualquier_id_deberia_incorporarlo_5_2172797 (clima_test.ClimaUnitTests) ... ok
test_constructor_con_cualquier_idioma_deberia_incorporarlo_1_None (clima_test.ClimaUnitTests) ... ok
test_constructor_con_cualquier_idioma_deberia_incorporarlo_2_ (clima_test.ClimaUnitTests) ... ok
test_constructor_con_cualquier_idioma_deberia_incorporarlo_3_sp (clima_test.ClimaUnitTests) ... ok
test_constructor_con_cualquier_pais_deberia_incorporarlo_1_None (clima_test.ClimaUnitTests) ... ok
test_constructor_con_cualquier_pais_deberia_incorporarlo_2_ (clima_test.ClimaUnitTests) ... ok
test_constructor_con_cualquier_pais_deberia_incorporarlo_3_ar (clima_test.ClimaUnitTests) ... ok
test_constructor_con_cualquier_pais_deberia_incorporarlo_4_uy (clima_test.ClimaUnitTests) ... ok
test_constructor_con_fahrenheit_deberia_incorporarlo (clima_test.ClimaUnitTests) ... ok
test_constructor_con_kelvin_deberia_incorporarlo (clima_test.ClimaUnitTests) ... ok
test_constructor_con_latitud_o_longitud_nulas_y_ninguna_otra_locacion_deberia_lanzar_valueerror (clima_test.ClimaUnitTests) ... ok
test_constructor_con_none_deberia_lanzar_valueerror (clima_test.ClimaUnitTests) ... ok
test_constructor_con_un_url_servicio_invalido_deberia_lanzar_valueerror_1_None (clima_test.ClimaUnitTests) ... ok
test_constructor_con_un_url_servicio_invalido_deberia_lanzar_valueerror_2_ (clima_test.ClimaUnitTests) ... ok
test_constructor_con_un_url_servicio_invalido_deberia_lanzar_valueerror_3_____ (clima_test.ClimaUnitTests) ... ok
test_constructor_con_una_apikey_en_blanco_deberia_lanzar_valueerror (clima_test.ClimaUnitTests) ... ok
test_constructor_con_una_apikey_vacia_deberia_lanzar_valueerror (clima_test.ClimaUnitTests) ... ok
test_constructor_con_una_apikey_valida_deberia_incorporarla (clima_test.ClimaUnitTests) ... ok
test_obtener_con_el_objeto_creado_deberia_obtener_json (clima_test.ClimaUnitTests) ... ok
test_url_con_datos_deberia_crear_url_1__2172797__None__None__None___None__None________fahrenheit____http___api_openweathermap_org_data_2_5_weather_appid_abcdefg_id_2172797_units_imperial__ (clima_test.ClimaUnitTests) ... ok
test_url_con_datos_deberia_crear_url_2__None___Sydney____au___None___None__None____fr____kelvin____http___api_openweathermap_org_data_2_5_weather_appid_abcdefg_q_Sydney_au_lang_fr__ (clima_test.ClimaUnitTests) ... ok
test_url_con_datos_deberia_crear_url_3__None__None__None__None___34_6037__58_3816____es____celsius____http___api_openweathermap_org_data_2_5_weather_appid_abcdefg_lat_34_6037_lon_58_3816_lang_es_units_metric__ (clima_test.ClimaUnitTests) ... ok
test_url_con_datos_deberia_crear_url_4__None__None__None___94040____None__None____ja____fahrenheit____http___api_openweathermap_org_data_2_5_weather_appid_abcdefg_zip_94040_lang_ja_units_imperial__ (clima_test.ClimaUnitTests) ... ok
test_url_con_datos_deberia_crear_url_5__None__None___ar____94040____None__None____ja____fahrenheit____http___api_openweathermap_org_data_2_5_weather_appid_abcdefg_zip_94040_ar_lang_ja_units_imperial__ (clima_test.ClimaUnitTests) ... ok
test_build_con_varios_valores_deberia_crearlo_con_ellos_1__2172797__None__None__None__None__None___english____fahrenheit____http___api_openweathermap_org_data_1_0_weather__ (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_build_con_varios_valores_deberia_crearlo_con_ellos_2__None___Sydney____au___None__None__None___australian_english____kelvin____http___api_openweathermap_org_data_1_5_weather__ (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_build_con_varios_valores_deberia_crearlo_con_ellos_3__None__None__None__None__34_6037__58_3816___sp____celsius____http___api_openweathermap_org_data_2_0_weather__ (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_build_con_varios_valores_deberia_crearlo_con_ellos_4__None__None__None___92730___None__None___en____fahrenheit____http___api_openweathermap_org_data_2_5_weather__ (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_con_apikey_con_cualquier_apikey_deberia_incorporarla_1_None (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_con_apikey_con_cualquier_apikey_deberia_incorporarla_2_ (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_con_apikey_con_cualquier_apikey_deberia_incorporarla_3___ (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_con_apikey_con_cualquier_apikey_deberia_incorporarla_4_abcdefg (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_con_ciudad_con_cualquier_ciudad_deberia_incorporarla_1_None (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_con_ciudad_con_cualquier_ciudad_deberia_incorporarla_2_ (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_con_ciudad_con_cualquier_ciudad_deberia_incorporarla_3___ (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_con_ciudad_con_cualquier_ciudad_deberia_incorporarla_4_abcdefg (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_con_id_con_cualquier_id_deberia_incorporarlo_1__33 (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_con_id_con_cualquier_id_deberia_incorporarlo_2_0 (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_con_id_con_cualquier_id_deberia_incorporarlo_3_1 (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_con_id_con_cualquier_id_deberia_incorporarlo_4_10 (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_con_id_con_cualquier_id_deberia_incorporarlo_5_1000 (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_con_servicio_con_cualquier_url_deberia_incorporarlo_1_None (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_con_servicio_con_cualquier_url_deberia_incorporarlo_2_ (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_con_servicio_con_cualquier_url_deberia_incorporarlo_3_____ (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_con_servicio_con_cualquier_url_deberia_incorporarlo_4_http___www_example_com (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_con_servicio_con_cualquier_url_deberia_incorporarlo_5_http___api_openweathermap_org_data_2_5_weather (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_constructor_con_creacion_deberia_tener_idioma_ciudad_grados_pais_url (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_en_celsius_con_celsius_flag_deberia_incorporarlo (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_en_codigo_postal_con_cualquier_codigo_postal_deberia_aceptarlo_1_None (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_en_codigo_postal_con_cualquier_codigo_postal_deberia_aceptarlo_2_ (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_en_codigo_postal_con_cualquier_codigo_postal_deberia_aceptarlo_3___ (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_en_codigo_postal_con_cualquier_codigo_postal_deberia_aceptarlo_4_abcdefg (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_en_coordenadas_con_cualquier_coordenada_deberia_incorporarla_1__0__0_ (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_en_coordenadas_con_cualquier_coordenada_deberia_incorporarla_2___1__10_ (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_en_coordenadas_con_cualquier_coordenada_deberia_incorporarla_3__13___1_ (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_en_coordenadas_con_cualquier_coordenada_deberia_incorporarla_4___8___6_ (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_en_fahrenheit_con_fahrenheit_flag_deberia_incorporarlo (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_en_idioma_con_cualquier_idioma_deberia_incorporarlo_1_ (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_en_idioma_con_cualquier_idioma_deberia_incorporarlo_2___ (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_en_idioma_con_cualquier_idioma_deberia_incorporarlo_3_es (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_en_idioma_con_cualquier_idioma_deberia_incorporarlo_4_english (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_en_kelvin_con_kelvin_flag_deberia_incorporarlo (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_en_pais_con_cualquier_pais_deberia_incorporarlo_1_None (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_en_pais_con_cualquier_pais_deberia_incorporarlo_2_ (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_en_pais_con_cualquier_pais_deberia_incorporarlo_3___ (climabuilder_test.ClimaBuilderUnitTests) ... ok
test_en_pais_con_cualquier_pais_deberia_incorporarlo_4_abcdefg (climabuilder_test.ClimaBuilderUnitTests) ... ok
test___str__con_json_valido_deberia_generar_oracion_1___kelvin____K__ (pronostico_test.PronosticoUnitTests) ... ok
test___str__con_json_valido_deberia_generar_oracion_2___imperial____F__ (pronostico_test.PronosticoUnitTests) ... ok
test___str__con_json_valido_deberia_generar_oracion_3___metric____C__ (pronostico_test.PronosticoUnitTests) ... ok
test_constructor_con_json_nulo_deberia_lanzar_valueerror (pronostico_test.PronosticoUnitTests) ... ok
test_constructor_con_json_valido_deberia_incorporarlo (pronostico_test.PronosticoUnitTests) ... ok
test_con_el_sistema_completo_deberia_funcionar (sistema_test.SistemaTests) ... ok

----------------------------------------------------------------------
Ran 83 tests in 1.079s

OK
</pre>

        <h2>Prueba final</h2>

        <p>Se implementa un programa que utilice las clases que han sido creadas:<p>

        <pre class="source-code">
import sys
import argparse
from climabuilder import ClimaBuilder
from clima import Clima
from pronostico import Pronostico

def main():
    climaBuilder = ClimaBuilder()
    parser = argparse.ArgumentParser(description="Process Clima calls.")

    parser.add_argument('--id', help='id de la ciudad', default=climaBuilder.id, type=int)
    parser.add_argument('--coordenadas', help='latitud,longitud de la ciudad', default=None, action='append', type=float)
    parser.add_argument('--ciudad', help='nombre de la ciudad', default=climaBuilder.ciudad)
    parser.add_argument('--codigo-postal', help='código postal de la ciudad', default=climaBuilder.codigo_postal)
    parser.add_argument('--pais', help='país', default=climaBuilder.pais)
    parser.add_argument('--key', help='la API key a usar en la conexión', default=climaBuilder.apikey)
    parser.add_argument('--temperatura', help='formato de la temperatura', choices=['fahrenheit', 'celsius', 'kelvin'], default=climaBuilder.grados)
    args = parser.parse_args()

    climaBuilder = (
        climaBuilder.con_apikey("3fce6c5b0d0d33d0766739c6b1473517")
                    .con_servicio("http://api.openweathermap.org/data/2.5/weather")
                    .con_ciudad(args.ciudad)
                    .en_pais(args.pais)
                    .en_codigo_postal(args.codigo_postal)
                    .en_pais(args.pais)
                    .con_id(args.id)
    )

    if args.temperatura == 'fahrenheit':
        climaBuilder.en_fahrenheit()
    elif args.temperatura == 'celsius':
        climaBuilder.en_celsius()
    else:
        climaBuilder.en_kelvin()

    clima = climaBuilder.build()

    if clima:
        pronostico = clima.obtener()

        if pronostico:
            print(pronostico)


if __name__ == "__main__":
    main()
</pre>

        <p>Es posible crear casos de uso para probar que tanto el programa como las librerías creadas funcionan correctamente, ya sea a través de pruebas de validación utilizando una librería como <a href="https://behave.readthedocs.io/en/latest/">behave</a>, o seleccionándolos a través de <a href="https://es.wikipedia.org/wiki/Pruebas_de_caja_blanca">pruebas de caja blanca</a>.

        <pre class="source-code">


        <h2 id="conclusion">Conclusiones</h2>

        <p>El costo de corrección de un error aumenta a medida que se avanza en el desarrollo del software, siendo mucho más barato resolver un problema en la etapa de análisis que en la de implementación, y las pruebas unitarias ayudan a descubrirlos de una manera rápida. El tiempo que se invierte implementando las pruebas debe verse como una inversión y no como una pérdida. Es mucho más fácil recrear el código fuente a partir de un juego completo de pruebas unitarias que recrear las pruebas a partir del código fuente.</p>

        <p>La metodología <em>TDD</em> puede también aplicarse a proyectos ya maduros: Primero se deben generar pruebas de integración que validen el funcionamiento correcto de los módulos entre sí, y a partir de ahí generar las pruebas unitarias por cada módulo utilizando las pruebas de integración para verificar que no se ha modificado el funcionamiento.</p>

        <h2 id="bibliografia">Bibliografía</h2>
        <ul>
            <li>Software Testing - A Self-Teaching Introduction, Rajiv Chopra</li>
            <li>Design Patterns - Elements of Reusable Object-Oriented Software, Gamma, Helm, Johnson, Vlissides</li>
            <li>Test Driven Development: By Example, Kent Beck)</li>
            <li>Extreme Programming Explained: Embrance Change, Kent Beck</li>
            <li>Diseño Ágil con TDD, Carlos Blé Jurado</li>
        </ul>
    </body>
</html>

<!--
Vim modelines
vim70:et:ts=4:noai:nosi:fenc=utf-8
-->
